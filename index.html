<!DOCTYPE html>
<html>
<head>
    <title>Advance Party Sync</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { background-color: #0f0f0f; color: #eee; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 20px; text-align: center; }
        
        /* Video Player Area */
        #player-wrapper { position: relative; max-width: 800px; margin: 0 auto; border: 2px solid #333; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        .video-container { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; background: black; }
        .video-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        
        /* Controls */
        .controls { margin-top: 15px; background: #1e1e1e; padding: 15px; border-radius: 8px; display: inline-block; }
        input[type="text"] { padding: 8px; width: 250px; background: #333; border: 1px solid #444; color: white; border-radius: 4px; }
        button { padding: 8px 15px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 4px; font-weight: bold; }
        button:hover { background: #0056b3; }
        
        /* Advanced Sync Panel */
        .sync-panel { margin-top: 20px; padding: 10px; border-top: 1px solid #333; }
        .latency-btn { background: #444; font-size: 12px; margin: 0 2px; }
        .latency-display { font-family: monospace; color: #ffcc00; margin: 0 10px; }
        
        /* Volume Control */
        .vol-container { margin-top: 10px; display: flex; align-items: center; justify-content: center; gap: 10px; }
        input[type=range] { cursor: pointer; }

        .status { color: #00ff00; margin-top: 10px; font-size: 14px; }
        .big-btn { background: #dc3545; font-size: 16px; width: 100%; max-width: 300px; margin-top: 10px; }
    </style>
</head>
<body>

    <h1>üé• Ultra Sync Party</h1>

    <div id="player-wrapper">
        <div class="video-container">
            <div id="player"></div>
        </div>
    </div>

    <div class="status" id="syncStatus">Connecting...</div>

    <div class="controls">
        <input type="text" id="videoUrlInput" placeholder="Paste YouTube Link...">
        <button onclick="loadNewVideo()">Load Video</button>
        
        <div class="vol-container">
            <span>üîä Vol:</span>
            <input type="range" id="volSlider" min="0" max="100" value="100" oninput="changeVolume(this.value)">
            <span id="volText">100%</span>
        </div>
    </div>

    <div class="sync-panel">
        <h3>‚ö° Manual Latency Fix</h3>
        <p style="font-size: 12px; color: #aaa;">‡¶Ø‡¶¶‡¶ø ‡¶∏‡¶æ‡¶â‡¶®‡ßç‡¶° ‡¶Ü‡¶ó‡ßá/‡¶™‡¶∞‡ßá ‡¶∂‡ßã‡¶®‡¶æ ‡¶Ø‡¶æ‡ßü, ‡¶®‡¶ø‡¶ö‡ßá‡¶∞ ‡¶¨‡¶æ‡¶ü‡¶® ‡¶¶‡¶ø‡ßü‡ßá ‡¶†‡¶ø‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®:</p>
        
        <button class="latency-btn" onclick="adjustOffset(-0.1)">-0.1s</button>
        <button class="latency-btn" onclick="adjustOffset(-0.05)">-0.05s</button>
        <span class="latency-display" id="offsetDisplay">Offset: 0ms</span>
        <button class="latency-btn" onclick="adjustOffset(0.05)">+0.05s</button>
        <button class="latency-btn" onclick="adjustOffset(0.1)">+0.1s</button>
        
        <br><br>
        <button class="big-btn" onclick="forceSync()">üîÑ FORCE SYNC NOW</button>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>
    
    <script>
        var socket = io();
        var player;
        var ignoreEvent = false;
        
        // Sync Logic Variables
        var lastHostTime = 0;
        var lastPacketTime = 0;
        var userOffset = 0; // ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßÅ‡ßü‡¶æ‡¶≤‡¶ø ‡¶Ø‡ßá‡¶ü‡¶æ ‡¶†‡¶ø‡¶ï ‡¶ï‡¶∞‡¶¨‡ßá
        var networkLatency = 0.5; // ‡¶°‡¶ø‡¶´‡¶≤‡ßç‡¶ü ‡¶®‡ßá‡¶ü‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶ï ‡¶¨‡¶æ‡¶´‡¶æ‡¶∞
        var isHost = false; 

        // 1. YOUTUBE PLAYER SETUP
        function onYouTubeIframeAPIReady() {
            player = new YT.Player('player', {
                height: '100%', width: '100%',
                videoId: '',
                playerVars: { 'playsinline': 1, 'controls': 1, 'rel': 0 },
                events: {
                    'onReady': onPlayerReady,
                    'onStateChange': onPlayerStateChange
                }
            });
        }

        function onPlayerReady(event) {
            document.getElementById("syncStatus").innerText = "Ready! Waiting for host...";
            player.setVolume(100);
        }

        // 2. VIDEO LOADING
        function loadNewVideo() {
            var url = document.getElementById("videoUrlInput").value;
            var videoId = extractVideoID(url);
            if(videoId) {
                socket.emit('change_video', videoId);
                document.getElementById("videoUrlInput").value = "";
            }
        }

        function extractVideoID(url) {
            var regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
            var match = url.match(regExp);
            return (match && match[2].length == 11) ? match[2] : null;
        }

        // 3. ADVANCED VOLUME CONTROL
        function changeVolume(val) {
            if(player) {
                player.setVolume(val);
                document.getElementById("volText").innerText = val + "%";
            }
        }

        // 4. MANUAL LATENCY ADJUSTMENT (The "Fix" Feature)
        function adjustOffset(amount) {
            userOffset += amount;
            // ‡¶∞‡¶æ‡¶â‡¶®‡ßç‡¶°‡¶ø‡¶Ç ‡¶´‡¶ø‡¶ï‡ßç‡¶∏ (‡¶¶‡¶∂‡¶Æ‡¶ø‡¶ï‡ßá‡¶∞ ‡¶ù‡¶æ‡¶Æ‡ßá‡¶≤‡¶æ ‡¶ï‡¶Æ‡¶æ‡¶®‡ßã‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø)
            userOffset = Math.round(userOffset * 1000) / 1000;
            
            document.getElementById("offsetDisplay").innerText = "Offset: " + (userOffset * 1000) + "ms";
            document.getElementById("syncStatus").innerText = "Adjusted! Next sync will use this offset.";
            
            // ‡¶∏‡¶æ‡¶•‡ßá ‡¶∏‡¶æ‡¶•‡ßá ‡¶è‡¶´‡ßá‡¶ï‡ßç‡¶ü ‡¶¶‡ßá‡¶ñ‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø:
            forceSync();
        }

        // 5. CORE SYNC LOGIC
        function forceSync() {
            if(!player) return;
            player.unMute();
            
            // Formula: HostTime + (Time passed since msg) + NetworkBuffer + ManualOffset
            var now = Date.now();
            var timePassed = (now - lastPacketTime) / 1000;
            var targetTime = lastHostTime + timePassed + networkLatency + userOffset;

            console.log("Syncing to:", targetTime);
            document.getElementById("syncStatus").innerText = "Syncing to " + targetTime.toFixed(2) + "s";
            
            player.seekTo(targetTime, true);
            player.playVideo();
        }

        // 6. SOCKET HANDLERS
        socket.on('change_video', function(newID) {
            if(player && player.loadVideoById) player.loadVideoById(newID);
        });

        socket.on('video_control', function(msg) {
            ignoreEvent = true;
            isHost = false; 

            // ‡¶Ø‡¶ñ‡¶® ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶æ‡¶∞ ‡¶•‡ßá‡¶ï‡ßá ‡¶ï‡¶Æ‡¶æ‡¶®‡ßç‡¶° ‡¶Ü‡¶∏‡¶¨‡ßá, ‡¶§‡¶ñ‡¶® ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßÅ‡ßü‡¶æ‡¶≤ ‡¶Ö‡¶´‡¶∏‡ßá‡¶ü ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßá ‡¶™‡ßç‡¶≤‡ßá ‡¶π‡¶¨‡ßá
            if (msg.action === 'play') {
                var target = msg.time + networkLatency + userOffset;
                player.seekTo(target, true);
                player.playVideo();
            } else if (msg.action === 'pause') {
                player.pauseVideo();
            } else if (msg.action === 'seek') {
                player.seekTo(msg.time, true);
            }
            setTimeout(() => { ignoreEvent = false; }, 500);
        });

        // Host Heartbeat
        socket.on('time_update', function(msg) {
            lastHostTime = msg.time;
            lastPacketTime = Date.now();
            document.getElementById("syncStatus").innerText = "Host Time: " + Math.round(msg.time) + "s";
            
            // AUTO DRIFT CORRECTION
            // ‡¶Ø‡¶¶‡¶ø ‡¶Ü‡¶Æ‡¶ø ‡¶π‡ßã‡¶∏‡ßç‡¶ü ‡¶®‡¶æ ‡¶π‡¶á ‡¶è‡¶¨‡¶Ç ‡¶≠‡¶ø‡¶°‡¶ø‡¶ì ‡¶™‡ßç‡¶≤‡ßá ‡¶•‡¶æ‡¶ï‡ßá
            if(!isHost && player && player.getPlayerState() == YT.PlayerState.PLAYING) {
                var myTime = player.getCurrentTime();
                var hostActualTime = msg.time + ((Date.now() - lastPacketTime)/1000);
                var diff = Math.abs(myTime - hostActualTime);

                // ‡¶Ø‡¶¶‡¶ø ‡¶ó‡ßç‡¶Ø‡¶æ‡¶™ ‡ß® ‡¶∏‡ßá‡¶ï‡ßá‡¶®‡ßç‡¶°‡ßá‡¶∞ ‡¶¨‡ßá‡¶∂‡¶ø ‡¶π‡ßü, ‡¶Ö‡¶ü‡ßã ‡¶´‡¶ø‡¶ï‡ßç‡¶∏ ‡¶ï‡¶∞‡ßã
                if(diff > 2.0) {
                    console.log("Drift detected! Auto syncing...");
                    forceSync();
                }
            }
        });

        // 7. HOST BROADCAST LOOP
        setInterval(() => {
            if (player && player.getPlayerState && player.getPlayerState() == YT.PlayerState.PLAYING) {
                // ‡¶Ü‡¶Æ‡¶ø ‡¶™‡ßç‡¶≤‡ßá ‡¶ï‡¶∞‡ßá‡¶õ‡¶ø ‡¶Æ‡¶æ‡¶®‡ßá ‡¶Ü‡¶Æ‡¶ø‡¶á ‡¶è‡¶ñ‡¶® ‡¶π‡ßã‡¶∏‡ßç‡¶ü
                // ‡¶≤‡¶ú‡¶ø‡¶ï: ‡¶Ø‡ßá ‡¶∂‡ßá‡¶∑‡¶¨‡¶æ‡¶∞ ‡¶™‡ßç‡¶≤‡ßá ‡¶¨‡¶æ‡¶ü‡¶®‡ßá ‡¶ö‡¶æ‡¶™ ‡¶¶‡¶ø‡ßü‡ßá‡¶õ‡ßá ‡¶¨‡¶æ ‡¶Ø‡¶æ‡¶∞ ‡¶≠‡¶ø‡¶°‡¶ø‡¶ì ‡¶ö‡¶≤‡¶õ‡ßá, ‡¶∏‡ßá ‡¶ü‡¶æ‡¶á‡¶Æ ‡¶™‡¶æ‡¶†‡¶æ‡¶¨‡ßá
                if(isHost) {
                    socket.emit('time_update', { time: player.getCurrentTime() });
                }
            }
        }, 1000);

        function onPlayerStateChange(event) {
            if (ignoreEvent) return;
            
            // ‡¶Ü‡¶Æ‡¶ø ‡¶ï‡¶®‡ßç‡¶ü‡ßç‡¶∞‡ßã‡¶≤ ‡¶ï‡¶∞‡¶≤‡ßá ‡¶Ü‡¶Æ‡¶ø ‡¶π‡ßã‡¶∏‡ßç‡¶ü
            if (event.data == YT.PlayerState.PLAYING) {
                isHost = true;
                socket.emit('video_control', { action: 'play', time: player.getCurrentTime() });
            } else if (event.data == YT.PlayerState.PAUSED) {
                isHost = true;
                socket.emit('video_control', { action: 'pause', time: player.getCurrentTime() });
            } else if (event.data == YT.PlayerState.BUFFERING) {
                 isHost = true;
                 socket.emit('video_control', { action: 'seek', time: player.getCurrentTime() });
            }
        }
    </script>
</body>
</html>