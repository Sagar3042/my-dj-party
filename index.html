<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>0.0000 Latency Sync</title>
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <style>
        :root { --neon: #00ffcc; --bg: #000000; --panel: #111; --red: #ff3333; }
        body { background: var(--bg); color: var(--neon); font-family: 'Share Tech Mono', monospace; margin: 0; overflow: hidden; }
        
        .hidden { display: none !important; }
        .flex-c { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; }
        
        /* LOGIN */
        #login { position: fixed; width: 100%; height: 100%; background: #000; z-index: 100; }
        input { background: #111; border: 1px solid var(--neon); color: white; padding: 15px; font-family: inherit; font-size: 1.2rem; text-align: center; width: 70%; margin-bottom: 20px; }
        button { background: var(--neon); color: black; border: none; padding: 15px 30px; font-size: 1.5rem; font-weight: bold; cursor: pointer; margin: 10px; font-family: inherit; text-transform: uppercase; }
        
        /* ADMIN UI */
        #admin-view { padding: 10px; height: 100vh; display: flex; flex-direction: column; }
        .deck { border: 1px solid #333; padding: 15px; margin-bottom: 10px; background: #050505; }
        .play-btn { width: 100%; height: 80px; font-size: 2rem; background: #004433; color: var(--neon); border: 1px solid var(--neon); margin-top:10px; }
        
        /* USER UI */
        #user-view { text-align: center; }
        .status-text { font-size: 4rem; margin: 0; text-shadow: 0 0 20px var(--neon); }
        .drift-info { color: #555; font-size: 0.8rem; margin-top: 10px; }
        
        /* JOYSTICK */
        .joy-pad { width: 180px; height: 180px; border: 2px solid #333; border-radius: 50%; margin: 20px auto; position: relative; background: #000; }
        .knob { width: 50px; height: 50px; background: var(--neon); border-radius: 50%; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); box-shadow: 0 0 15px var(--neon); }

        #player-wrapper { position: absolute; top: -5000px; opacity: 0; }
    </style>
</head>
<body>

    <div id="login" class="flex-c">
        <h1>SYSTEM <span style="color:white">ZERO</span></h1>
        <input id="uName" placeholder="ENTER CODENAME">
        <button onclick="start('admin')">ADMIN TERMINAL</button>
        <button onclick="start('user')" style="background:#333; color:white; border:1px solid white;">RECEIVER</button>
    </div>

    <div id="admin-view" class="hidden">
        <div class="deck">
            <input id="yLink" placeholder="YOUTUBE LINK" style="width:60%; font-size:1rem; padding:10px;">
            <button onclick="load()" style="font-size:1rem; padding:10px;">LOAD</button>
        </div>
        
        <div class="deck" style="flex-grow: 1; display:flex; flex-direction:column; justify-content:center;">
            <div id="admTime" style="text-align:center; font-size:3rem;">0.00s</div>
            <button class="play-btn" onclick="masterPlay()">‚ñ∂ EXECUTE PLAY</button>
            <button class="play-btn" onclick="masterPause()" style="background:#440000; color:var(--red); border-color:var(--red); height:60px; font-size:1.5rem;">‚è∏ HALT</button>
        </div>

        <div class="deck">
            <div class="joy-pad" id="joyBase"><div class="knob" id="joyKnob"></div></div>
        </div>
    </div>

    <div id="user-view" class="hidden flex-c">
        <div class="drift-info" id="pingStats">LATENCY: 0.00ms</div>
        <div class="status-text" id="uStatus">STANDBY</div>
        <h2 id="volDisp" style="font-size:5rem; margin-top:50px;">100%</h2>
        <button onclick="hardSync()" style="margin-top:30px; font-size:1rem; background:transparent; border:1px solid #333; color:#555;">RESYNC ENGINE</button>
    </div>

    <div id="player-wrapper"><div id="player"></div></div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>
    <script>
        const socket = io();
        let player;
        let role = '';
        
        // üî• THE SECRET WEAPON: ADMIN DELAY
        // Admin waits this many ms before playing locally, 
        // giving the user time to catch up.
        const ADMIN_DELAY_MS = 1000; 

        function start(r) {
            let name = document.getElementById('uName').value || "Unit 1";
            role = r;
            
            // Audio Unlock
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            gain.gain.value = 0.0001; osc.connect(gain); gain.connect(ctx.destination);
            osc.start();

            document.getElementById('login').classList.add('hidden');
            if(role === 'admin') {
                document.getElementById('admin-view').classList.remove('hidden');
                setupJoy();
                startAdminClock();
            } else {
                document.getElementById('user-view').classList.remove('hidden');
            }
            socket.emit('join', { name: name, role: role });
        }

        function onYouTubeIframeAPIReady() {
            player = new YT.Player('player', {
                height: '100%', width: '100%', videoId: '',
                playerVars: { 'playsinline': 1, 'controls': 0, 'disablekb': 1 },
                events: { 'onStateChange': (e) => {} }
            });
        }

        // --- ADMIN ENGINE ---
        function startAdminClock() {
            setInterval(() => {
                if(player && player.getCurrentTime) {
                    let t = player.getCurrentTime();
                    document.getElementById('admTime').innerText = t.toFixed(2);
                    
                    // Continuous Sync Pulse
                    if(player.getPlayerState() === 1) {
                        socket.emit('admin_pulse', {
                            time: t,
                            isPlaying: true
                        });
                    }
                }
            }, 200);
        }

        // üî• MASTER PLAY LOGIC
        function masterPlay() {
            if(!player) return;
            let t = player.getCurrentTime();
            
            // 1. Send command to User IMMEDIATELY
            socket.emit('master_play', { seekTime: t });

            // 2. Admin WAITS (Simulating Lag)
            // This allows the user to receive the signal and start 
            // BEFORE the admin actually starts.
            setTimeout(() => {
                player.playVideo();
            }, ADMIN_DELAY_MS);
        }

        function masterPause() {
            if(!player) return;
            let t = player.getCurrentTime();
            socket.emit('master_pause', { seekTime: t });
            player.pauseVideo(); // Admin pauses immediately
        }

        function load() {
            let url = document.getElementById('yLink').value;
            let id = "";
            if (url.includes("v=")) id = url.split('v=')[1].split('&')[0];
            else if (url.includes("youtu.be/")) id = url.split('youtu.be/')[1].split('?')[0];
            else if (url.length === 11) id = url;
            if(id.length===11) socket.emit('change_track', id);
        }

        // --- USER ENGINE ---
        socket.on('load_track', (id) => player.loadVideoById(id));

        // ‚ö° EXECUTE PLAY
        socket.on('execute_play', (data) => {
            if(role !== 'user') return;
            
            // User receives command INSTANTLY.
            // Since Admin is waiting 1000ms, User has a headstart.
            // This cancels out the network latency.
            
            let now = Date.now();
            let networkLag = (now - data.timestamp); // How long msg took

            document.getElementById('uStatus').innerText = "SYNCED";
            document.getElementById('uStatus').style.color = "var(--neon)";

            // Just Play. Don't think.
            // The Admin's delay handles the math.
            player.seekTo(data.seekTime, true);
            player.playVideo();
        });

        socket.on('execute_pause', (data) => {
            if(role !== 'user') return;
            player.seekTo(data.seekTime, true);
            player.pauseVideo();
            document.getElementById('uStatus').innerText = "HALTED";
            document.getElementById('uStatus').style.color = "var(--red)";
        });

        // ‚ö° CONTINUOUS CORRECTION
        socket.on('sync_correction', (data) => {
            if(role !== 'user' || !player) return;
            if(player.getPlayerState() !== 1) return; // Only if playing

            let now = Date.now();
            // Estimate Admin's REAL time (Data Time + Network Time)
            let latency = (now - data.serverTime) / 1000;
            // Admin is actually here:
            // (Note: Admin started 1s late, so we don't need to add that back, 
            // we just match the timestamp)
            let targetTime = data.time + latency; 

            let myTime = player.getCurrentTime();
            let diff = myTime - targetTime; // + I am ahead, - I am behind

            document.getElementById('pingStats').innerText = `DRIFT: ${(diff*1000).toFixed(0)}ms`;

            // AGGRESSIVE CORRECTION
            if (Math.abs(diff) > 0.5) {
                // If more than 0.5s off, Hard Seek
                player.seekTo(targetTime, true);
            } else if (diff < -0.05) {
                // Behind? Go faster
                player.setPlaybackRate(1.1);
            } else if (diff > 0.05) {
                // Ahead? Go slower
                player.setPlaybackRate(0.9);
            } else {
                player.setPlaybackRate(1.0);
            }
        });

        function hardSync() {
            if(player) player.playVideo();
        }

        // Spatial Audio
        socket.on('vol_adjust', (d) => {
            if(role !== 'user') return;
            let dist = Math.sqrt(d.x*d.x + d.y*d.y);
            let vol = Math.max(0, 100 - (dist*50));
            player.setVolume(vol);
            document.getElementById('volDisp').innerText = Math.floor(vol)+"%";
        });

        function setupJoy() {
            const pad=document.getElementById('joyBase'), knob=document.getElementById('joyKnob');
            let drag=false;
            function move(e) {
                e.preventDefault();
                let cx = e.touches?e.touches[0].clientX:e.clientX;
                let cy = e.touches?e.touches[0].clientY:e.clientY;
                let r = pad.getBoundingClientRect();
                let x = cx-(r.left+90), y = cy-(r.top+90);
                let dist = Math.sqrt(x*x+y*y);
                if(dist>60){ x=(x/dist)*60; y=(y/dist)*60; }
                knob.style.transform=`translate(-50%,-50%) translate(${x}px,${y}px)`;
                socket.emit('admin_joystick',{x:x/60, y:y/60});
            }
            knob.addEventListener('mousedown',()=>drag=true);
            document.addEventListener('mouseup',()=>drag=false);
            document.addEventListener('mousemove',(e)=>{if(drag)move(e)});
            knob.addEventListener('touchstart',()=>drag=true);
            document.addEventListener('touchend',()=>drag=false);
            document.addEventListener('touchmove',(e)=>{if(drag)move(e)});
        }
    </script>
</body>
</html>