<!DOCTYPE html>
<html>
<head>
    <title>Advance Sync System</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { background-color: #121212; color: #eee; font-family: sans-serif; margin: 0; padding: 0; display: flex; flex-direction: column; align-items: center; }
        
        /* LOGIN MODAL */
        #loginModal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 1000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .login-box { background: #222; padding: 30px; border-radius: 10px; text-align: center; border: 1px solid #444; }
        .login-btn { padding: 10px 20px; font-size: 18px; background: #007bff; color: white; border: none; cursor: pointer; border-radius: 5px; margin-top: 10px; }
        
        /* VIDEO PLAYER */
        #player-wrapper { position: relative; width: 100%; max-width: 800px; aspect-ratio: 16/9; background: black; margin-top: 20px; border: 2px solid #333; }
        #player { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        
        /* USER SHIELD (‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶§‡ßá ‡¶≠‡¶ø‡¶°‡¶ø‡¶ì‡¶§‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶®‡¶æ ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá) */
        #user-shield { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; display: none; }

        /* CONTROLS */
        .controls { margin-top: 15px; background: #1e1e1e; padding: 15px; border-radius: 8px; width: 90%; max-width: 800px; text-align: center; }
        
        /* ADMIN PANEL Only */
        #admin-panel { display: none; border-top: 1px solid #444; margin-top: 10px; padding-top: 10px; }
        input[type="text"] { padding: 8px; width: 60%; background: #333; border: 1px solid #444; color: white; }
        
        .status { color: #00ff00; margin-top: 5px; font-size: 14px; font-family: monospace; }
        
        /* Latency Buttons */
        .latency-btn { background: #444; color: white; border: 1px solid #666; padding: 5px 10px; cursor: pointer; margin: 2px; }
    </style>
</head>
<body>

    <div id="loginModal">
        <div class="login-box">
            <h2>Select Your Role</h2>
            <label style="font-size: 18px;">
                <input type="checkbox" id="isAdminCheck"> I am the Admin (Host)
            </label>
            <br><br>
            <button class="login-btn" onclick="enterParty()">Join Party</button>
        </div>
    </div>

    <div id="player-wrapper">
        <div id="player"></div>
        <div id="user-shield"></div>
    </div>

    <div class="controls">
        <h3 id="role-text">Waiting...</h3>
        <div class="status" id="syncStatus">Status: Connecting...</div>

        <div id="user-controls" style="margin-top: 10px;">
            <small>Audio Latency Fix:</small>
            <button class="latency-btn" onclick="adjustOffset(-0.1)">-0.1s</button>
            <button class="latency-btn" onclick="adjustOffset(0.1)">+0.1s</button>
            <button class="latency-btn" style="background:red" onclick="forceSync()">‚ö° SYNC</button>
        </div>

        <div id="admin-panel">
            <input type="text" id="videoUrlInput" placeholder="Paste YouTube Link...">
            <button class="latency-btn" style="background: #007bff;" onclick="loadNewVideo()">Load Video</button>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>
    
    <script>
        var socket = io();
        var player;
        var isAdmin = false;
        var manualOffset = 0; // ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßÅ‡ßü‡¶æ‡¶≤‡¶ø ‡¶ü‡¶æ‡¶á‡¶Æ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶ú‡¶æ‡¶∏‡ßç‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá
        var networkLatency = 0.3; // ‡¶¨‡¶æ‡¶´‡¶æ‡¶∞ ‡¶ü‡¶æ‡¶á‡¶Æ

        // --- 1. SETUP & LOGIN ---
        function enterParty() {
            isAdmin = document.getElementById("isAdminCheck").checked;
            document.getElementById("loginModal").style.display = "none";
            
            if(isAdmin) {
                document.getElementById("role-text").innerText = "üëë You are ADMIN (You Control)";
                document.getElementById("admin-panel").style.display = "block";
                document.getElementById("user-shield").style.display = "none"; // ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá
                document.getElementById("user-controls").style.display = "none"; // ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶®‡ßá‡¶∞ ‡¶∏‡¶ø‡¶ô‡ßç‡¶ï ‡¶¨‡¶æ‡¶ü‡¶® ‡¶¶‡¶∞‡¶ï‡¶æ‡¶∞ ‡¶®‡ßá‡¶á
            } else {
                document.getElementById("role-text").innerText = "üë§ You are USER (Watching)";
                document.getElementById("user-shield").style.display = "block"; // ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá ‡¶®‡¶æ
            }
        }

        // --- 2. YOUTUBE API ---
        function onYouTubeIframeAPIReady() {
            player = new YT.Player('player', {
                height: '100%', width: '100%',
                videoId: '',
                playerVars: { 'playsinline': 1, 'controls': 1, 'rel': 0 },
                events: {
                    'onReady': onPlayerReady,
                    'onStateChange': onPlayerStateChange
                }
            });
        }

        function onPlayerReady(event) {
            document.getElementById("syncStatus").innerText = "Player Ready!";
        }

        // --- 3. ADMIN FUNCTIONS ---
        function loadNewVideo() {
            if(!isAdmin) return;
            var url = document.getElementById("videoUrlInput").value;
            var videoId = extractVideoID(url);
            if(videoId) {
                socket.emit('change_video', videoId);
                document.getElementById("videoUrlInput").value = "";
            }
        }

        // ‡¶¨‡ßç‡¶∞‡¶°‡¶ï‡¶æ‡¶∏‡ßç‡¶ü ‡¶≤‡ßÅ‡¶™ (‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶ü‡¶æ‡¶á‡¶Æ ‡¶™‡¶æ‡¶†‡¶æ‡¶¨‡ßá)
        setInterval(() => {
            if (isAdmin && player && player.getPlayerState && player.getPlayerState() == YT.PlayerState.PLAYING) {
                socket.emit('admin_time_update', { time: player.getCurrentTime() });
            }
        }, 1000);

        // --- 4. EVENT LISTENERS (SOCKET) ---
        
        socket.on('change_video', (id) => {
            if(player && player.loadVideoById) player.loadVideoById(id);
        });

        // ‡¶™‡ßç‡¶≤‡ßá/‡¶™‡¶ú ‡¶∞‡¶ø‡¶∏‡¶ø‡¶≠ ‡¶ï‡¶∞‡¶æ
        socket.on('video_control', (msg) => {
            if(isAdmin) return; // ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶®‡¶ø‡¶ú‡ßá‡¶∞ ‡¶ï‡¶Æ‡¶æ‡¶®‡ßç‡¶° ‡¶á‡¶ó‡¶®‡ßã‡¶∞ ‡¶ï‡¶∞‡¶¨‡ßá

            if (msg.action === 'play') {
                var target = msg.time + networkLatency + manualOffset;
                // ‡¶Ø‡¶¶‡¶ø ‡¶ó‡ßç‡¶Ø‡¶æ‡¶™ ‡¶ñ‡ßÅ‡¶¨ ‡¶¨‡ßá‡¶∂‡¶ø ‡¶π‡ßü, ‡¶∏‡¶ø‡¶ï ‡¶ï‡¶∞‡ßã
                if(Math.abs(player.getCurrentTime() - target) > 0.5) {
                    player.seekTo(target, true);
                }
                player.playVideo();
            } else if (msg.action === 'pause') {
                player.pauseVideo();
            } else if (msg.action === 'seek') {
                player.seekTo(msg.time + manualOffset, true);
            }
        });

        // ‡¶Ö‡¶ü‡ßã‡¶Æ‡ßá‡¶ü‡¶ø‡¶ï ‡¶ü‡¶æ‡¶á‡¶Æ ‡¶´‡¶ø‡¶ï‡ßç‡¶∏ (Heartbeat Sync)
        socket.on('server_time_sync', (msg) => {
            if(isAdmin) return;

            var hostTime = msg.time;
            document.getElementById("syncStatus").innerText = "Host: " + hostTime.toFixed(1) + "s";

            // ‡¶Ø‡¶¶‡¶ø ‡¶≠‡¶ø‡¶°‡¶ø‡¶ì ‡¶™‡ßç‡¶≤‡ßá ‡¶•‡¶æ‡¶ï‡ßá ‡¶è‡¶¨‡¶Ç ‡¶ü‡¶æ‡¶á‡¶Æ‡ßá‡¶∞ ‡¶™‡¶æ‡¶∞‡ßç‡¶•‡¶ï‡ßç‡¶Ø ‡ßß ‡¶∏‡ßá‡¶ï‡ßá‡¶®‡ßç‡¶°‡ßá‡¶∞ ‡¶¨‡ßá‡¶∂‡¶ø ‡¶π‡ßü
            if(player.getPlayerState() == YT.PlayerState.PLAYING) {
                var myTime = player.getCurrentTime();
                var diff = Math.abs(myTime - (hostTime + manualOffset));

                if(diff > 1.0) { // ‡ßß ‡¶∏‡ßá‡¶ï‡ßá‡¶®‡ßç‡¶°‡ßá‡¶∞ ‡¶¨‡ßá‡¶∂‡¶ø ‡¶ó‡ßç‡¶Ø‡¶æ‡¶™ ‡¶π‡¶≤‡ßá ‡¶Ö‡¶ü‡ßã ‡¶´‡¶ø‡¶ï‡ßç‡¶∏
                    console.log("Auto syncing...");
                    player.seekTo(hostTime + networkLatency + manualOffset, true);
                }
            }
        });

        // --- 5. USER FUNCTIONS ---
        function adjustOffset(val) {
            manualOffset += val;
            document.getElementById("syncStatus").innerText = "Offset Adjusted: " + manualOffset.toFixed(1) + "s";
        }

        function forceSync() {
            // ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßÅ‡ßü‡¶æ‡¶≤‡¶ø ‡¶≤‡ßá‡¶ü‡ßá‡¶∏‡ßç‡¶ü ‡¶ü‡¶æ‡¶á‡¶Æ‡ßá ‡¶®‡¶ø‡ßü‡ßá ‡¶Ø‡¶æ‡¶ì
             socket.emit('request_time'); // ‡¶è‡¶ü‡¶ø ‡¶´‡¶ø‡¶â‡¶ö‡¶æ‡¶∞ ‡¶á‡¶Æ‡¶™‡ßç‡¶∞‡ßÅ‡¶≠‡¶Æ‡ßá‡¶®‡ßç‡¶ü‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø
             // ‡¶Ü‡¶™‡¶æ‡¶§‡¶§ ‡¶ú‡¶æ‡¶∏‡ßç‡¶ü ‡¶Ü‡¶®‡¶Æ‡¶ø‡¶â‡¶ü ‡¶è‡¶¨‡¶Ç ‡¶™‡ßç‡¶≤‡ßá
             player.unMute();
             player.playVideo();
        }

        // --- 6. PLAYER STATE CHANGE (Only Admin Sends This) ---
        function onPlayerStateChange(event) {
            if (!isAdmin) return; // ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶¶‡ßá‡¶∞ ‡¶•‡ßá‡¶ï‡ßá ‡¶ï‡ßã‡¶®‡ßã ‡¶∏‡¶ø‡¶ó‡¶®‡¶æ‡¶≤ ‡¶Ø‡¶æ‡¶¨‡ßá ‡¶®‡¶æ

            if (event.data == YT.PlayerState.PLAYING) {
                socket.emit('video_control', { action: 'play', time: player.getCurrentTime() });
            } else if (event.data == YT.PlayerState.PAUSED) {
                socket.emit('video_control', { action: 'pause', time: player.getCurrentTime() });
            } else if (event.data == YT.PlayerState.BUFFERING) {
                 socket.emit('video_control', { action: 'seek', time: player.getCurrentTime() });
            }
        }

        function extractVideoID(url) {
            var regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
            var match = url.match(regExp);
            return (match && match[2].length == 11) ? match[2] : null;
        }

    </script>
</body>
</html>