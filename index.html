<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Perfect Speed Sync</title>
    <link href="https://fonts.googleapis.com/css2?family=Teko:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root { --main: #00ff88; --bg: #050505; --panel: #111; }
        body { background: var(--bg); color: white; font-family: 'Teko', sans-serif; margin: 0; overflow: hidden; }
        
        .hidden { display: none !important; }
        .flex-c { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; }

        /* LOGIN */
        #login { position: fixed; z-index: 10; background: rgba(0,0,0,0.95); width: 100%; }
        input { background: #222; border: 1px solid #444; color: var(--main); padding: 10px; font-size: 1.2rem; text-align: center; margin: 10px; width: 60%; }
        button { background: var(--main); color: black; border: none; padding: 10px 30px; font-size: 1.5rem; font-weight: bold; cursor: pointer; margin: 5px; clip-path: polygon(10% 0, 100% 0, 100% 80%, 90% 100%, 0 100%, 0 20%); }
        button:active { transform: scale(0.95); }

        /* ADMIN UI */
        #admin-view { padding: 20px; display: grid; grid-template-rows: auto 1fr auto; height: 100vh; box-sizing: border-box; }
        .deck { background: var(--panel); padding: 15px; border: 1px solid #333; margin-bottom: 10px; }
        
        /* USER UI */
        #user-view { text-align: center; }
        .status-big { font-size: 4rem; margin: 0; line-height: 1; color: var(--main); text-shadow: 0 0 20px var(--main); }
        .sync-mode { font-size: 1.2rem; color: #aaa; margin-top: 10px; font-family: sans-serif; }
        
        /* JOYSTICK */
        .joy-area { width: 200px; height: 200px; border: 2px solid #333; border-radius: 50%; margin: 20px auto; position: relative; background: #080808; }
        .knob { width: 60px; height: 60px; background: var(--main); border-radius: 50%; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); box-shadow: 0 0 15px var(--main); }

        /* USER LIST */
        .user-list { max-height: 200px; overflow-y: auto; text-align: left; }
        .user-item { padding: 5px; border-bottom: 1px solid #222; color: #888; }

        #player-wrapper { position: absolute; top: -2000px; opacity: 0; pointer-events: none; }
    </style>
</head>
<body>

    <div id="login" class="flex-c">
        <h1 style="font-size:3rem; margin:0;">SPEED <span style="color:var(--main)">SYNC</span></h1>
        <input id="uName" placeholder="Enter Name">
        <button onclick="start('admin')">DJ MODE</button>
        <button onclick="start('user')" style="background:#00aaff; color:white;">LISTENER</button>
    </div>

    <div id="admin-view" class="hidden">
        <div class="deck">
            <input id="yLink" placeholder="YouTube Link" style="width:60%;">
            <button onclick="load()" style="font-size:1rem;">LOAD</button>
            <div style="margin-top:10px; display:flex; justify-content:space-between;">
                <button onclick="toggle()" style="width:48%">‚èØ PLAY/PAUSE</button>
                <div style="font-size:2rem; color:white;" id="admTime">0.0s</div>
            </div>
        </div>
        
        <div class="deck user-list" id="uList"></div>

        <div class="joy-area" id="joyBase">
            <div class="knob" id="joyKnob"></div>
        </div>
    </div>

    <div id="user-view" class="hidden flex-c">
        <div class="status-big" id="uStatus">WAITING</div>
        <div class="sync-mode" id="uMode">Speed: Normal</div>
        
        <h2 id="volDisp" style="margin-top:50px; font-size:3rem;">100%</h2>
        <p>Volume</p>

        <div id="debug" style="color:#444; font-size:10px; margin-top:20px;"></div>
    </div>

    <div id="player-wrapper"><div id="player"></div></div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>
    <script>
        const socket = io();
        let player;
        let role = '';
        
        function start(r) {
            let name = document.getElementById('uName').value || "Guest";
            role = r;
            
            // Audio Context Unlock
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            gain.gain.value = 0.0001; osc.connect(gain); gain.connect(ctx.destination);
            osc.start();

            document.getElementById('login').classList.add('hidden');
            if(role === 'admin') {
                document.getElementById('admin-view').classList.remove('hidden');
                setupJoy();
                startAdminPulse();
            } else {
                document.getElementById('user-view').classList.remove('hidden');
            }
            socket.emit('join', { name: name, role: role });
        }

        // --- YOUTUBE ---
        function onYouTubeIframeAPIReady() {
            player = new YT.Player('player', {
                height: '100%', width: '100%', videoId: '',
                playerVars: { 'playsinline': 1, 'controls': 0, 'disablekb': 1 },
                events: { 'onStateChange': (e) => {} }
            });
        }

        // --- ADMIN ENGINE ---
        function startAdminPulse() {
            setInterval(() => {
                if(player && player.getCurrentTime) {
                    let t = player.getCurrentTime();
                    document.getElementById('admTime').innerText = t.toFixed(1) + "s";
                    // Send High-Freq Pulse
                    socket.emit('admin_signal', {
                        time: t,
                        isPlaying: (player.getPlayerState() === 1),
                        timestamp: Date.now()
                    });
                }
            }, 200); // 5 times per second for precision
        }

        function load() {
            let url = document.getElementById('yLink').value;
            let id = "";
            if (url.includes("v=")) id = url.split('v=')[1].split('&')[0];
            else if (url.includes("youtu.be/")) id = url.split('youtu.be/')[1].split('?')[0];
            else if (url.length === 11) id = url;
            
            if(id.length===11) {
                socket.emit('change_track', id);
                player.loadVideoById(id);
            }
        }
        function toggle() {
            if(player.getPlayerState()===1) player.pauseVideo(); else player.playVideo();
        }

        socket.on('user_update', (users) => {
            if(role!=='admin') return;
            let d = document.getElementById('uList'); d.innerHTML = "";
            for(let k in users) if(users[k].role!=='admin') 
                d.innerHTML += `<div class="user-item">üë§ ${users[k].name}</div>`;
        });

        // --- USER ENGINE (THE SPEED LOGIC) ---
        socket.on('load_track', (id) => player.loadVideoById(id));
        
        socket.on('sync_pulse', (data) => {
            if(role !== 'user' || !player) return;

            // 1. Calculate precise Admin time considering Network Latency
            let now = Date.now();
            let networkLag = (now - data.timestamp) / 1000;
            let targetTime = data.time + networkLag; 

            let myTime = player.getCurrentTime();
            let drift = targetTime - myTime; // Positive = I am lagging

            document.getElementById('debug').innerText = `Drift: ${drift.toFixed(3)}s | Target: ${targetTime.toFixed(1)}`;

            // 2. STATE SYNC
            if(data.isPlaying) {
                document.getElementById('uStatus').innerText = "PLAYING";
                document.getElementById('uStatus').style.color = "var(--main)";
                if(player.getPlayerState() !== 1 && player.getPlayerState() !== 3) player.playVideo();
            } else {
                document.getElementById('uStatus').innerText = "PAUSED";
                document.getElementById('uStatus').style.color = "#777";
                if(player.getPlayerState() === 1) player.pauseVideo();
                // If paused, hard sync once
                if(Math.abs(drift) > 0.5) player.seekTo(targetTime, true);
                return; // Stop speed logic when paused
            }

            // 3. SPEED SYNC LOGIC (The Magic)
            
            // Case A: HUGE LAG (> 2s) -> Hard Jump
            if(Math.abs(drift) > 2.0) {
                document.getElementById('uMode').innerText = "Syncing (Hard Jump)...";
                player.seekTo(targetTime + 0.1, true); // +0.1 for safety
            } 
            // Case B: SMALL LAG (0.1s to 2.0s) -> Speed Up (Catch up)
            else if (drift > 0.15) {
                document.getElementById('uMode').innerText = "Status: Catching Up ‚è©";
                player.setPlaybackRate(1.15); // 15% Faster
            } 
            // Case C: AHEAD (-0.1s to -2.0s) -> Slow Down (Wait)
            else if (drift < -0.15) {
                document.getElementById('uMode').innerText = "Status: Slowing Down ‚è™";
                player.setPlaybackRate(0.85); // 15% Slower
            } 
            // Case D: PERFECT (< 0.15s) -> Normal Speed
            else {
                document.getElementById('uMode').innerText = "Status: Perfect Synced üëå";
                player.setPlaybackRate(1.0);
            }
        });

        // Spatial Audio
        socket.on('vol_adjust', (d) => {
            if(role !== 'user') return;
            let dist = Math.sqrt(d.x*d.x + d.y*d.y);
            let vol = Math.max(0, 100 - (dist*50));
            player.setVolume(vol);
            document.getElementById('volDisp').innerText = Math.floor(vol)+"%";
        });

        function setupJoy() {
            const pad=document.getElementById('joyBase'), knob=document.getElementById('joyKnob');
            let drag=false;
            function move(e) {
                e.preventDefault();
                let cx = e.touches?e.touches[0].clientX:e.clientX;
                let cy = e.touches?e.touches[0].clientY:e.clientY;
                let r = pad.getBoundingClientRect();
                let x = cx-(r.left+100), y = cy-(r.top+100);
                let dist = Math.sqrt(x*x+y*y);
                if(dist>70){ x=(x/dist)*70; y=(y/dist)*70; }
                knob.style.transform=`translate(-50%,-50%) translate(${x}px,${y}px)`;
                socket.emit('admin_joystick',{x:x/70, y:y/70});
            }
            knob.addEventListener('mousedown',()=>drag=true);
            document.addEventListener('mouseup',()=>drag=false);
            document.addEventListener('mousemove',(e)=>{if(drag)move(e)});
            knob.addEventListener('touchstart',()=>drag=true);
            document.addEventListener('touchend',()=>drag=false);
            document.addEventListener('touchmove',(e)=>{if(drag)move(e)});
        }
    </script>
</body>
</html>