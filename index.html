<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zero Latency Theater</title>
    <style>
        :root { --primary: #00d2ff; --bg: #050505; --panel: #111; }
        body { background-color: var(--bg); color: #ddd; font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; flex-direction: column; align-items: center; }
        
        /* LOGIN */
        #login-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.98); z-index: 99; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .login-box { background: var(--panel); padding: 40px; border: 1px solid #333; border-radius: 10px; text-align: center; }
        input { padding: 12px; background: #222; border: 1px solid #444; color: white; border-radius: 5px; width: 250px; margin-bottom: 10px; outline: none; }
        button { padding: 12px 25px; cursor: pointer; border: none; border-radius: 5px; font-weight: bold; transition: 0.2s; }
        .btn-main { background: var(--primary); color: black; }
        .btn-main:hover { background: #3399ff; }

        /* PLAYER */
        .theater-mode { width: 100%; max-width: 1000px; padding: 20px; }
        .video-container { position: relative; padding-bottom: 56.25%; background: black; border: 2px solid #222; box-shadow: 0 0 30px rgba(0, 210, 255, 0.1); }
        #player { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        .blocker { position: absolute; inset: 0; z-index: 10; display: none; }

        /* INFO BAR */
        .info-bar { display: flex; justify-content: space-between; margin-top: 15px; padding: 10px; background: var(--panel); border-radius: 5px; border: 1px solid #333; }
        .sync-status { font-family: monospace; font-size: 13px; color: #888; }
        .live-dot { height: 8px; width: 8px; background: red; border-radius: 50%; display: inline-block; margin-right: 5px; }
        
        /* ADMIN PANEL */
        #admin-panel { display: none; width: 100%; max-width: 1000px; margin-top: 20px; border-top: 1px solid #333; padding-top: 20px; }
        .admin-controls { display: flex; gap: 10px; margin-bottom: 20px; }
        .user-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; }
        .user-card { background: var(--panel); padding: 10px; border: 1px solid #333; border-radius: 5px; font-size: 13px; }
        
        .drift-good { color: #00ff00; }
        .drift-bad { color: #ff0000; }
    </style>
</head>
<body>

    <div id="login-modal">
        <div class="login-box">
            <h2 style="color: var(--primary);">üöÄ ENTER ROOM</h2>
            <input type="text" id="username" placeholder="Nickname...">
            <div style="margin: 15px; text-align: left; font-size: 14px;">
                <label><input type="checkbox" id="isAdmin"> I am the Host</label>
            </div>
            <button class="btn-main" onclick="startApp()">JOIN</button>
        </div>
    </div>

    <div class="theater-mode" id="main-ui" style="display:none;">
        <div class="video-container">
            <div id="player"></div>
            <div class="blocker" id="clickBlocker"></div>
        </div>

        <div class="info-bar">
            <div id="video-title">Waiting for video...</div>
            <div class="sync-status" id="debug-stats">Connecting...</div>
        </div>

        <div id="admin-panel">
            <div class="admin-controls">
                <input type="text" id="videoUrl" placeholder="Paste YouTube Link (Any format)" style="width: 100%;">
                <button class="btn-main" onclick="loadVideo()">PLAY</button>
                <button style="background: #ff3333; color: white;" onclick="forceSyncAll()">FORCE SYNC ALL</button>
            </div>
            <h4 style="margin:0 0 10px 0; color: #666;">AUDIENCE MONITOR</h4>
            <div class="user-grid" id="user-list"></div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>
    
    <script>
        const socket = io();
        let player;
        let isAdmin = false;
        
        // --- ZERO LATENCY ENGINE VARS ---
        let latestHostData = null;
        let serverOffset = 0; // Difference between server clock and local clock
        let ping = 0;

        // 1. APP START
        function startApp() {
            let name = document.getElementById('username').value || "User";
            isAdmin = document.getElementById('isAdmin').checked;
            
            document.getElementById('login-modal').style.display = 'none';
            document.getElementById('main-ui').style.display = 'block';

            socket.emit('join_user', name);

            if(isAdmin) {
                document.getElementById('admin-panel').style.display = 'block';
                document.getElementById('clickBlocker').style.display = 'none';
            } else {
                document.getElementById('clickBlocker').style.display = 'block';
            }
        }

        // 2. YOUTUBE API
        function onYouTubeIframeAPIReady() {
            player = new YT.Player('player', {
                height: '100%', width: '100%',
                videoId: '',
                playerVars: { 'playsinline': 1, 'controls': 0, 'rel': 0, 'modestbranding': 1, 'disablekb': 1 },
                events: { 'onReady': onPlayerReady, 'onStateChange': onPlayerStateChange }
            });
        }

        function onPlayerReady() {
            // Start Loops
            if(isAdmin) setInterval(hostLoop, 500); // Host sends data frequently
            setInterval(syncLoop, 500); // Everyone checks sync
        }

        // --- 3. URL PARSER FIX (UPDATED) ---
        function loadVideo() {
            let url = document.getElementById('videoUrl').value;
            let videoId = "";
            
            // Powerful Regex to handle ?si=, &t=, shorts, etc.
            try {
                let urlObj = new URL(url);
                if(urlObj.hostname.includes('youtu.be')) {
                    videoId = urlObj.pathname.slice(1);
                } else if (urlObj.hostname.includes('youtube.com')) {
                    videoId = urlObj.searchParams.get("v");
                    if(!videoId && urlObj.pathname.includes('/embed/')) {
                        videoId = urlObj.pathname.split('/embed/')[1];
                    }
                }
            } catch(e) {
                // Fallback if not a full URL
                videoId = url;
            }

            if(videoId) {
                socket.emit('change_video', videoId);
                document.getElementById('videoUrl').value = "";
            } else {
                alert("Invalid Link! Please try again.");
            }
        }

        // --- 4. HOST LOGIC ---
        function hostLoop() {
            if(!player || !player.getCurrentTime) return;
            // Host Sends: Current Time, State, and Rate
            let state = player.getPlayerState();
            if(state === 1 || state === 2) { // Play or Pause
                socket.emit('host_update', {
                    time: player.getCurrentTime(),
                    state: state,
                    rate: player.getPlaybackRate()
                });
            }
        }

        function onPlayerStateChange(event) {
            // Trigger immediate update on state change
            if(isAdmin) hostLoop();
        }

        // --- 5. CLIENT SYNC LOGIC (THE BRAIN) ---
        function syncLoop() {
            if(isAdmin || !latestHostData || !player) return;

            // Step A: Calculate Real Host Time
            // Formula: HostReportedTime + (Now - ServerTimestamp) + NetworkAdjustment
            // We assume server sent data 'Now - ping/2' ago.
            
            let timeSinceServerMsg = (Date.now() - latestHostData.serverTimestamp) / 1000;
            let currentHostTime = latestHostData.hostTime;
            
            if(latestHostData.isPlaying) {
                currentHostTime += (timeSinceServerMsg * latestHostData.rate);
            }

            // Step B: Compare with My Time
            let myTime = player.getCurrentTime();
            let drift = currentHostTime - myTime; // Positive = I'm behind
            
            // Update UI
            document.getElementById('debug-stats').innerHTML = 
                `Ping: ${(timeSinceServerMsg*1000).toFixed(0)}ms | Gap: ${drift.toFixed(3)}s | <span style="color:${drift > 0.1 ? 'red' : 'green'}">‚óè</span>`;
            
            socket.emit('report_drift', drift.toFixed(3));

            // Step C: Action
            let absDrift = Math.abs(drift);
            
            if (absDrift > 2.0) {
                // Hard Jump (If gap is huge)
                player.seekTo(currentHostTime + 0.1, true);
            } 
            else if (absDrift > 0.1) { 
                // Micro Speed Adjustment (Smooth Sync)
                // If behind, speed up (1.1x). If ahead, slow down (0.9x).
                let targetRate = drift > 0 ? 1.15 : 0.9;
                
                // Only change rate if playing
                if(latestHostData.isPlaying) {
                    player.setPlaybackRate(targetRate);
                    // Ensure video is playing
                    if(player.getPlayerState() !== 1) player.playVideo();
                }
            } else {
                // Perfect Sync zone
                player.setPlaybackRate(1);
                
                // Sync Pause/Play State
                let myState = player.getPlayerState();
                if(latestHostData.isPlaying && myState !== 1 && myState !== 3) {
                    player.playVideo();
                } else if (!latestHostData.isPlaying && myState === 1) {
                    player.pauseVideo();
                    // Fine tune pause position
                    if(Math.abs(player.getCurrentTime() - currentHostTime) > 0.1) {
                         player.seekTo(currentHostTime, true);
                    }
                }
            }
        }

        // --- 6. SOCKET EVENTS ---
        socket.on('sync_video_id', (id) => {
            player.loadVideoById(id);
        });

        socket.on('server_pulse', (data) => {
            latestHostData = data;
        });
        
        // Initial state sync (for new joiners)
        socket.on('sync_player_state', (data) => {
             player.seekTo(data.time, true);
             if(data.action === 'play') player.playVideo();
             else player.pauseVideo();
        });

        socket.on('execute_admin_command', (data) => {
            if(isAdmin) return;
            if(data.type === 'force_sync') {
                // Reset everything
                player.seekTo(latestHostData.hostTime, true);
                player.setPlaybackRate(1);
            }
        });

        socket.on('update_user_list', (users) => {
            if(!isAdmin) return;
            const grid = document.getElementById('user-list');
            grid.innerHTML = "";
            users.forEach(u => {
                if(u.id === socket.id) return;
                let color = Math.abs(u.drift) < 0.2 ? "drift-good" : "drift-bad";
                let div = document.createElement('div');
                div.className = "user-card";
                div.innerHTML = `<b>${u.name}</b><br>Gap: <span class="${color}">${u.drift}s</span>`;
                grid.appendChild(div);
            });
        });

        // Admin Functions
        function forceSyncAll() {
            socket.emit('admin_action', { type: 'force_sync' });
        }
    </script>
</body>
</html>