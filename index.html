<!DOCTYPE html>
<html>
<head>
    <title>Ultra Sync Party</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { background-color: #0f0f0f; color: #eee; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 20px; text-align: center; }
        
        #player-wrapper { position: relative; max-width: 800px; margin: 0 auto; border: 2px solid #333; box-shadow: 0 0 20px rgba(0,0,0,0.5); background: black; aspect-ratio: 16/9; }
        
        #waiting-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 20;
        }
        #waiting-screen h2 { color: #555; animation: blink 2s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }

        .video-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: transparent; z-index: 10; display: none; }
        
        .controls { margin-top: 15px; background: #1e1e1e; padding: 15px; border-radius: 8px; display: inline-block; }
        input[type="text"] { padding: 8px; width: 250px; background: #333; border: 1px solid #444; color: white; border-radius: 4px; }
        button { padding: 8px 15px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 4px; font-weight: bold; }
        button:hover { background: #0056b3; }
        .status { color: #00ff00; margin-top: 10px; font-size: 14px; }

        /* ADMIN PANEL */
        #admin-panel { display: none; margin-top: 30px; border-top: 2px solid #444; padding-top: 20px; text-align: left; max-width: 900px; margin-left: auto; margin-right: auto; }
        
        .master-controls {
            background: #2a2a2a; border: 2px solid #ff4444; padding: 15px;
            text-align: center; margin-bottom: 20px; border-radius: 10px;
        }
        .big-btn {
            font-size: 20px; padding: 15px 30px; margin: 10px;
            border-radius: 8px; cursor: pointer; border: none; color: white;
            font-weight: bold; width: 40%;
        }
        .big-minus { background: #dc3545; box-shadow: 0 4px 0 #a71d2a; }
        .big-minus:active { box-shadow: none; transform: translateY(4px); }
        .big-plus { background: #28a745; box-shadow: 0 4px 0 #1e7e34; }
        .big-plus:active { box-shadow: none; transform: translateY(4px); }

        .user-card { background: #252525; padding: 10px; margin-bottom: 10px; border-radius: 5px; display: flex; align-items: center; justify-content: space-between; border: 1px solid #333; }
        .user-info-box { width: 30%; }
        .user-name { font-weight: bold; color: #ffcc00; display: block;}
        .time-compare { font-size: 11px; color: #aaa; margin-top: 3px; font-family: monospace; display: block; }
        
        .admin-btn { font-size: 13px; padding: 6px 10px; margin: 0 2px; cursor: pointer; color: white; border: none; border-radius: 3px; }
        .btn-sync { background: #007bff; }
        .btn-minus { background: #d63384; }
        .btn-plus { background: #6610f2; }
        
        .slider-container { display: flex; align-items: center; gap: 5px; font-size: 12px; color: #aaa; }
        input[type=range] { width: 80px; }

        #login-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 100; display: flex; justify-content: center; align-items: center; flex-direction: column; }
    </style>
</head>
<body>

    <div id="login-modal">
        <h2>Enter Your Name</h2>
        <input type="text" id="username" placeholder="Name..." style="font-size: 18px; padding: 10px;">
        <br><br>
        <div style="font-size: 12px; color: #aaa; margin-bottom: 10px;">Are you Admin? (Check only if you are host)</div>
        <label><input type="checkbox" id="isAdminCheck"> I am Admin</label>
        <br><br>
        <button onclick="enterParty()" style="font-size: 18px;">JOIN PARTY</button>
    </div>

    <div id="main-content" style="display:none;">
        <h1>üé• Ultra Sync Party</h1>
        
        <div id="player-wrapper">
            <div id="waiting-screen">
                <h2>Waiting for Host...</h2>
            </div>
            <div id="player"></div>
            <div class="video-overlay" id="clickBlocker"></div>
        </div>

        <div class="status" id="syncStatus">Status: Idle</div>

        <div class="controls" id="videoLoader" style="display:none;">
            <input type="text" id="videoUrlInput" placeholder="Paste YouTube Link...">
            <button onclick="loadNewVideo()">Load Video</button>
        </div>

        <div id="admin-panel">
            <div class="master-controls">
                <h3 style="margin:0 0 10px 0; color: #fff;">üåç GLOBAL ADJUST (0.1s Steps)</h3>
                <button class="big-btn big-minus" onclick="adjustAll(-0.1)">- 0.1s</button>
                <button class="big-btn big-plus" onclick="adjustAll(0.1)">+ 0.1s</button>
            </div>

            <h3 style="color: #ffcc00; border-bottom: 1px solid #444; padding-bottom: 5px;">
                üë§ User Status Monitor
                <button onclick="syncAll()" style="float: right; font-size: 12px; background: #444;">RESET ALL SYNC</button>
            </h3>
            <div id="user-list-container"></div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>
    
    <script>
        var socket = io();
        var player;
        var isAdmin = false;
        var myName = "";
        
        // Sync Logic Variables
        var manualOffset = 0; 
        var networkLatency = 0.3; // ‡¶Ü‡¶∞‡ßã ‡¶ü‡¶æ‡¶á‡¶ü ‡¶¨‡¶æ‡¶´‡¶æ‡¶∞ (Hard Sync)
        var lastHostTime = 0;
        var lastPacketTime = 0;

        function enterParty() {
            myName = document.getElementById("username").value || "Guest";
            isAdmin = document.getElementById("isAdminCheck").checked;
            
            document.getElementById("login-modal").style.display = "none";
            document.getElementById("main-content").style.display = "block";
            
            socket.emit('join_user', myName);

            if(isAdmin) {
                document.getElementById("videoLoader").style.display = "block";
                document.getElementById("admin-panel").style.display = "block";
                document.getElementById("clickBlocker").style.display = "none"; 
                document.getElementById("waiting-screen").innerHTML = "<h2>Paste Link to Start</h2>";
            } else {
                document.getElementById("clickBlocker").style.display = "block"; 
            }
        }

        function onYouTubeIframeAPIReady() {
            player = new YT.Player('player', {
                height: '100%', width: '100%',
                videoId: '', 
                playerVars: { 'playsinline': 1, 'controls': 0, 'disablekb': 1, 'rel': 0 },
                events: { 'onStateChange': onPlayerStateChange }
            });
        }

        function loadNewVideo() {
            var url = document.getElementById("videoUrlInput").value;
            var videoId = extractVideoID(url);
            if(videoId) {
                socket.emit('change_video', videoId);
                document.getElementById("videoUrlInput").value = "";
            } else {
                alert("Invalid YouTube Link!");
            }
        }

        function extractVideoID(url) {
            var regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
            var match = url.match(regExp);
            return (match && match[2].length == 11) ? match[2] : null;
        }

        // --- HARD SYNC FUNCTION ---
        // ‡¶è‡¶á ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®‡¶ü‡¶ø ‡¶è‡¶ñ‡¶® ‡¶Ü‡¶∞‡ßã ‡¶®‡¶ø‡¶ñ‡ßÅ‡¶Å‡¶§‡¶≠‡¶æ‡¶¨‡ßá ‡¶∏‡¶ø‡¶ô‡ßç‡¶ï ‡¶ï‡¶∞‡¶¨‡ßá
        function performSmartSync() {
            if(!player || !player.seekTo) return;
            
            let now = Date.now();
            let timePassed = (now - lastPacketTime) / 1000;
            
            // Formula: HostTime + ProcessingTime + NetworkDelay + ManualAdjustment
            let target = lastHostTime + timePassed + networkLatency + manualOffset;
            
            player.seekTo(target, true);
            player.playVideo();
            player.unMute();
            
            if(!isAdmin) {
                document.getElementById("syncStatus").innerText = "Resyncing to " + target.toFixed(2) + "s...";
            }
        }

        // --- SOCKET LISTENERS ---
        socket.on('change_video', (id) => {
            document.getElementById("waiting-screen").style.display = "none";
            if(player && player.loadVideoById) player.loadVideoById(id);
        });

        // ‡¶®‡¶§‡ßÅ‡¶® ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶è‡¶≤‡ßá ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶∏‡¶æ‡¶•‡ßá ‡¶∏‡¶æ‡¶•‡ßá ‡¶ü‡¶æ‡¶á‡¶Æ ‡¶™‡¶æ‡¶†‡¶æ‡¶¨‡ßá
        socket.on('admin_request_time', () => {
            if(isAdmin && player && player.getCurrentTime) {
                socket.emit('time_update', { time: player.getCurrentTime() });
            }
        });

        socket.on('time_update', (msg) => {
            lastHostTime = msg.time;
            lastPacketTime = Date.now();
            
            if(!isAdmin) {
                // AUTO-JUMP LOGIC:
                // ‡¶Ø‡¶¶‡¶ø ‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶ü‡¶æ‡¶á‡¶Æ ‡¶è‡¶¨‡¶Ç ‡¶π‡ßã‡¶∏‡ßç‡¶ü‡ßá‡¶∞ ‡¶ü‡¶æ‡¶á‡¶Æ‡ßá‡¶∞ ‡¶™‡¶æ‡¶∞‡ßç‡¶•‡¶ï‡ßç‡¶Ø ‡ß® ‡¶∏‡ßá‡¶ï‡ßá‡¶®‡ßç‡¶°‡ßá‡¶∞ ‡¶¨‡ßá‡¶∂‡¶ø ‡¶π‡ßü,
                // ‡¶§‡¶æ‡¶π‡¶≤‡ßá ‡¶ú‡ßã‡¶∞ ‡¶ï‡¶∞‡ßá ‡¶∏‡¶ø‡¶ô‡ßç‡¶ï ‡¶ï‡¶∞‡ßã (‡¶®‡¶§‡ßÅ‡¶® ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶¶‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶è‡¶ü‡¶ø ‡¶ï‡¶æ‡¶ú ‡¶ï‡¶∞‡¶¨‡ßá)
                if(player && player.getCurrentTime) {
                    let myTime = player.getCurrentTime();
                    let diff = Math.abs(myTime - msg.time);
                    
                    if(diff > 2.0) {
                         console.log("Drift too high, Auto Syncing...");
                         performSmartSync();
                    }
                }

                document.getElementById("syncStatus").innerText = "Host: " + msg.time.toFixed(1) + "s | My Offset: " + manualOffset.toFixed(2) + "s";
            }
        });

        socket.on('force_client_update', (data) => {
            if(isAdmin) return; 

            if(data.type === 'sync') {
                performSmartSync();
            } else if (data.type === 'offset') {
                manualOffset += data.val;
                performSmartSync(); // Apply immediately
            } else if (data.type === 'volume') {
                if(player && player.setVolume) player.setVolume(data.val);
            }
        });

        socket.on('video_control', (msg) => {
            if(isAdmin) return;
            document.getElementById("waiting-screen").style.display = "none";
            if(msg.action === 'play') player.playVideo();
            else if(msg.action === 'pause') player.pauseVideo();
            else if(msg.action === 'seek') player.seekTo(msg.time);
        });

        // --- ADMIN UI LOOP ---
        setInterval(() => {
            if(!isAdmin && player && player.getCurrentTime && player.getPlayerState() === YT.PlayerState.PLAYING) {
                socket.emit('report_user_time', player.getCurrentTime());
            }
        }, 1000);

        socket.on('update_user_list', (users) => {
            if(!isAdmin) return;
            const container = document.getElementById("user-list-container");
            container.innerHTML = ""; 

            let myTime = 0;
            if(player && player.getCurrentTime) myTime = player.getCurrentTime();

            users.forEach(u => {
                if(u.id === socket.id) return;

                let timeDiff = Math.abs(myTime - u.lastKnownTime);
                let diffColor = timeDiff > 0.5 ? "red" : "#aaa";

                let row = document.createElement("div");
                row.className = "user-card";
                row.innerHTML = `
                    <div class="user-info-box">
                        <span class="user-name">${u.name}</span>
                        <span class="time-compare" style="color:${diffColor}">
                            Host: ${myTime.toFixed(1)} / User: ${u.lastKnownTime.toFixed(1)}
                        </span>
                    </div>
                    
                    <div style="display:flex; align-items:center;">
                        <button class="admin-btn btn-minus" onclick="adjustUser('${u.id}', 'offset', -0.1)">-0.1s</button>
                        <button class="admin-btn btn-plus" onclick="adjustUser('${u.id}', 'offset', 0.1)">+0.1s</button>
                    </div>

                    <div class="slider-container">
                        <span>üîä</span>
                        <input type="range" min="0" max="100" value="100" onchange="adjustUser('${u.id}', 'volume', this.value)">
                    </div>

                    <button class="admin-btn btn-sync" onclick="forceSyncUser('${u.id}')">FIX</button>
                `;
                container.appendChild(row);
            });
        });

        function forceSyncUser(socketId) {
            socket.emit('admin_action', { targetID: socketId, type: 'sync' });
        }
        function adjustUser(socketId, type, val) {
            val = parseFloat(val);
            socket.emit('admin_action', { targetID: socketId, type: type, val: val });
        }
        function adjustAll(val) {
            socket.emit('admin_action', { targetID: 'all', type: 'offset', val: val });
        }
        function syncAll() {
            socket.emit('admin_action', { targetID: 'all', type: 'sync' });
        }

        // Host Loop
        setInterval(() => {
            if (isAdmin && player && player.getPlayerState && player.getPlayerState() == YT.PlayerState.PLAYING) {
                socket.emit('time_update', { time: player.getCurrentTime() });
            }
        }, 1000);

        function onPlayerStateChange(event) {
            if (!isAdmin) return;
            if (event.data == YT.PlayerState.PLAYING) {
                socket.emit('video_control', { action: 'play', time: player.getCurrentTime() });
            } else if (event.data == YT.PlayerState.PAUSED) {
                socket.emit('video_control', { action: 'pause', time: player.getCurrentTime() });
            } else if (event.data == YT.PlayerState.BUFFERING) {
                 socket.emit('video_control', { action: 'seek', time: player.getCurrentTime() });
            }
        }
    </script>
</body>
</html>