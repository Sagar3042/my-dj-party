<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perfect Sync Theater</title>
    <style>
        body { margin: 0; background: #000; color: white; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; height: 100vh; }
        
        /* VIDEO CONTAINER */
        #video-container {
            width: 100%; max-width: 900px; aspect-ratio: 16/9; 
            background: #111; position: relative; border: 2px solid #333; margin-top: 20px;
        }
        #player { width: 100%; height: 100%; position: absolute; top: 0; left: 0; }
        
        /* CLICK BLOCKER (For Users) */
        #user-shield {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 10; background: transparent; display: none;
        }

        /* START OVERLAY (Fixes Autoplay Issue) */
        #start-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 100;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .start-btn {
            padding: 20px 40px; font-size: 20px; background: #e50914; color: white;
            border: none; border-radius: 5px; cursor: pointer; font-weight: bold;
            box-shadow: 0 0 20px #e50914; animation: pulse 2s infinite;
        }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        /* CONTROLS */
        .controls { margin-top: 20px; width: 90%; max-width: 900px; text-align: center; }
        input { padding: 10px; width: 70%; background: #222; border: 1px solid #444; color: white; }
        button { padding: 10px 20px; cursor: pointer; background: #007bff; color: white; border: none; }
        
        #status-text { margin-top: 10px; color: #0f0; font-family: monospace; }
        #admin-area { display: none; border-top: 1px solid #333; padding-top: 20px; margin-top: 20px;}
    </style>
</head>
<body>

    <div id="start-overlay">
        <h1>ðŸŽ¥ SYNC THEATER</h1>
        <div style="margin-bottom: 20px;">
            <input type="text" id="username" placeholder="Enter Name..." style="width: 200px; text-align: center;">
            <br><br>
            <label><input type="checkbox" id="isAdmin"> I am Admin (Host)</label>
        </div>
        <button class="start-btn" onclick="enterRoom()">TAP TO START</button>
    </div>

    <div id="video-container">
        <div id="player"></div>
        <div id="user-shield"></div> </div>

    <div class="controls">
        <div id="status-text">Waiting...</div>

        <div id="admin-area">
            <input type="text" id="videoUrl" placeholder="Paste YouTube Link Here...">
            <button onclick="loadVideo()">PLAY VIDEO</button>
            <br><br>
            <button onclick="forceSync()" style="background: #e50914;">âš¡ FORCE SYNC EVERYONE</button>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>
    
    <script>
        var socket = io();
        var player;
        var isAdmin = false;
        var isReady = false;

        // --- 1. SETUP ---
        function enterRoom() {
            var name = document.getElementById('username').value || "Guest";
            isAdmin = document.getElementById('isAdmin').checked;
            
            // Remove Overlay
            document.getElementById('start-overlay').style.display = 'none';
            
            // Setup UI
            if(isAdmin) {
                document.getElementById('admin-area').style.display = 'block';
                document.getElementById('user-shield').style.display = 'none';
            } else {
                document.getElementById('user-shield').style.display = 'block';
            }
            
            // Init YouTube
            if(window.YT && YT.Player) {
                onYouTubeIframeAPIReady();
            }
        }

        // --- 2. YOUTUBE API ---
        function onYouTubeIframeAPIReady() {
            player = new YT.Player('player', {
                height: '100%', width: '100%',
                videoId: '', // Start empty
                playerVars: { 
                    'playsinline': 1, 
                    'controls': 1, // Admin needs controls
                    'rel': 0,
                    'autoplay': 1, // Try to autoplay
                    'mute': 0      // Try with sound
                },
                events: {
                    'onReady': onPlayerReady,
                    'onStateChange': onPlayerStateChange,
                    'onError': onPlayerError
                }
            });
        }

        function onPlayerReady(event) {
            isReady = true;
            document.getElementById('status-text').innerText = "Player Ready! Waiting for video...";
        }

        function onPlayerError(event) {
            console.log("YouTube Error:", event.data);
            alert("Video Error! The video might be restricted or private.");
        }

        // --- 3. LOAD VIDEO LOGIC (FIXED) ---
        function loadVideo() {
            var url = document.getElementById('videoUrl').value;
            var videoId = extractID(url);
            
            if(videoId) {
                socket.emit('change_video', videoId);
                document.getElementById('videoUrl').value = "";
            } else {
                alert("Invalid YouTube URL!");
            }
        }

        function extractID(url) {
            var regExp = /^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#&?]*).*/;
            var match = url.match(regExp);
            return (match && match[7].length == 11) ? match[7] : false;
        }

        // --- 4. SOCKET LISTENERS ---
        socket.on('change_video', function(id) {
            if(isReady) {
                document.getElementById('status-text').innerText = "Loading Video...";
                player.loadVideoById(id);
            }
        });

        socket.on('player_update', function(data) {
            if(isAdmin) return; // Admin controls themselves
            if(!isReady) return;

            // Sync Logic
            var myTime = player.getCurrentTime();
            var diff = Math.abs(data.time - myTime);

            if(data.action === 'play') {
                if(diff > 0.5) player.seekTo(data.time, true);
                player.playVideo();
            } else {
                player.pauseVideo();
                player.seekTo(data.time, true);
            }
        });

        // --- 5. HOST LOGIC ---
        function onPlayerStateChange(event) {
            if(!isAdmin) return;

            var time = player.getCurrentTime();
            
            if (event.data == YT.PlayerState.PLAYING) {
                socket.emit('video_control', { action: 'play', time: time });
            } else if (event.data == YT.PlayerState.PAUSED) {
                socket.emit('video_control', { action: 'pause', time: time });
            } else if (event.data == YT.PlayerState.BUFFERING) {
                socket.emit('video_control', { action: 'play', time: time });
            }
        }
        
        function forceSync() {
            if(player) {
                socket.emit('video_control', { action: 'play', time: player.getCurrentTime() });
            }
        }
        
        // Loop to keep sync tight
        setInterval(function() {
            if(isAdmin && player && player.getPlayerState() == 1) {
                socket.emit('video_control', { action: 'play', time: player.getCurrentTime() });
            }
        }, 2000); // Send sync packet every 2 seconds

    </script>
</body>
</html>