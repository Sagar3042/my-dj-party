<!DOCTYPE html>
<html>
<head>
    <title>Ultra Low Latency Party</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { background-color: #121212; color: white; text-align: center; font-family: sans-serif; margin: 0; padding: 10px; }
        
        .control-panel { background: #222; padding: 15px; margin-bottom: 15px; border-radius: 8px; border: 1px solid #333; }
        input { padding: 10px; width: 60%; border-radius: 5px; border: none; background: #333; color: white; }
        button { padding: 10px; border-radius: 5px; border: none; cursor: pointer; font-weight: bold; margin: 5px; }
        .load-btn { background-color: #007bff; color: white; }
        
        /* Big Red Button */
        .sync-btn { 
            background-color: #ff0000; color: white; 
            width: 90%; max-width: 400px; padding: 15px; 
            font-size: 18px; text-transform: uppercase;
            box-shadow: 0px 0px 15px rgba(255, 0, 0, 0.4);
            animation: pulse 2s infinite;
        }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.8; } 100% { opacity: 1; } }

        #player-container { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; max-width: 800px; margin: auto; border: 2px solid #444; background: black;}
        #player-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        .status { color: #00ff00; font-size: 12px; margin-top: 5px; }
    </style>
</head>
<body>

    <div class="control-panel">
        <input type="text" id="videoUrlInput" placeholder="Paste YouTube Link...">
        <button class="load-btn" onclick="loadNewVideo()">Load</button>
        <div class="status" id="statusText">Connecting...</div>
    </div>

    <div id="player-container">
        <div id="player"></div>
    </div>
    
    <br>
    <button class="sync-btn" onclick="smartForceSync()">⚡ FIX AUDIO LAG / SYNC ⚡</button>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>
    
    <script>
        var socket = io();
        var player;
        var ignoreEvent = false;
        
        // Variables for Smart Sync Calculation
        var lastHostTime = 0;      // Host er video te koto time chilo
        var lastPacketTime = 0;    // Host er signal kokhon esheche (real time)
        var isHost = false;        // Ami ki host?

        function onYouTubeIframeAPIReady() {
            player = new YT.Player('player', {
                height: '100%',
                width: '100%',
                videoId: '', 
                playerVars: { 'playsinline': 1, 'rel': 0, 'controls': 1, 'autoplay': 1, 'mute': 1 }, // Auto mute to allow autoplay
                events: {
                    'onReady': onPlayerReady,
                    'onStateChange': onPlayerStateChange
                }
            });
        }

        function onPlayerReady(event) {
            document.getElementById("statusText").innerText = "Ready! Click Sync button to Unmute & Sync.";
        }

        function loadNewVideo() {
            var url = document.getElementById("videoUrlInput").value;
            var videoId = extractVideoID(url);
            if(videoId) {
                socket.emit('change_video', videoId);
                document.getElementById("videoUrlInput").value = "";
            }
        }

        function extractVideoID(url) {
            var regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
            var match = url.match(regExp);
            return (match && match[2].length == 11) ? match[2] : null;
        }

        // --- HOST LOGIC: Continuous Time Broadcast ---
        setInterval(() => {
            // Jodi video cholte thake ebong ami play kore thaki
            if (player && player.getPlayerState && player.getPlayerState() == YT.PlayerState.PLAYING) {
                // Host prottek second e tar current time pathabe
                // Kintu amra bujhbo kivabe ke host? Je last play button chepeche sei host.
                if(isHost){
                    socket.emit('time_update', { time: player.getCurrentTime() });
                }
            }
        }, 1000); // Prottek 1 second e update pathao

        // --- CLIENT LOGIC ---

        socket.on('change_video', function(newID) {
            if(player && player.loadVideoById) player.loadVideoById(newID);
        });

        socket.on('video_control', function(msg) {
            ignoreEvent = true;
            if (msg.action === 'play') {
                player.seekTo(msg.time + 0.3, true); // 0.3s add korlam network delay cover korte
                player.playVideo();
                isHost = false; // Onno keu control korche, tai ami host na
            } else if (msg.action === 'pause') {
                player.pauseVideo();
                isHost = false;
            } else if (msg.action === 'seek') {
                player.seekTo(msg.time, true);
                isHost = false;
            }
            setTimeout(() => { ignoreEvent = false; }, 500);
        });

        // Host er "Heartbeat" (Time update) receive kora
        socket.on('time_update', function(msg) {
            lastHostTime = msg.time;
            lastPacketTime = Date.now(); // Signal ashar time record koro
            document.getElementById("statusText").innerText = "Host Time: " + Math.round(msg.time) + "s";
        });

        // --- SMART FORCE SYNC FUNCTION ---
        function smartForceSync() {
            if(!player) return;
            
            // 1. Unmute (browser er policy fix korar jonno)
            player.unMute(); 
            
            // 2. CALCULATION: Host er time koto chilo + Signal aste koto derry hoyeche
            var now = Date.now();
            var timePassedSinceSignal = (now - lastPacketTime) / 1000; // Millisecond ke Second e nilam
            
            // Amra assume korchi internet delay pray 0.5 second (Buffer)
            var targetTime = lastHostTime + timePassedSinceSignal + 0.5;

            console.log("Syncing to:", targetTime);
            document.getElementById("statusText").innerText = "Syncing to " + targetTime.toFixed(2) + "s";

            // 3. Jump to exact future time
            player.seekTo(targetTime, true);
            player.playVideo();
        }

        function onPlayerStateChange(event) {
            if (ignoreEvent) return;
            
            // Jodi ami Play/Pause kori, tahole ami ekhon Host
            if (event.data == YT.PlayerState.PLAYING) {
                isHost = true;
                socket.emit('video_control', { action: 'play', time: player.getCurrentTime() });
            } else if (event.data == YT.PlayerState.PAUSED) {
                isHost = true;
                socket.emit('video_control', { action: 'pause', time: player.getCurrentTime() });
            } else if (event.data == YT.PlayerState.BUFFERING) {
                 isHost = true;
                 socket.emit('video_control', { action: 'seek', time: player.getCurrentTime() });
            }
        }
    </script>
</body>
</html>