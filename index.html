<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Zero Latency Player</title>
    <link href="https://fonts.googleapis.com/css2?family=Teko:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root { --main: #00ffcc; --bg: #0a0a0a; --panel: #141414; --danger: #ff0055; }
        body { background: var(--bg); color: white; font-family: 'Teko', sans-serif; margin: 0; overflow: hidden; }
        
        .hidden { display: none !important; }
        .flex-c { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; }

        /* LOGIN */
        #login { position: fixed; z-index: 10; background: rgba(0,0,0,0.95); width: 100%; height: 100%; top:0; left:0; }
        input { background: #222; border: 1px solid #444; color: var(--main); padding: 15px; font-size: 1.5rem; text-align: center; margin: 10px; width: 70%; border-radius: 10px; }
        button { background: var(--main); color: black; border: none; padding: 15px 40px; font-size: 1.8rem; font-weight: bold; cursor: pointer; margin: 10px; clip-path: polygon(10% 0, 100% 0, 100% 80%, 90% 100%, 0 100%, 0 20%); transition: 0.2s; }
        button:active { transform: scale(0.95); }

        /* ADMIN UI */
        #admin-view { padding: 10px; display: grid; grid-template-rows: auto 1fr auto; height: 100vh; box-sizing: border-box; }
        .deck { background: var(--panel); padding: 15px; border: 1px solid #333; margin-bottom: 10px; border-radius: 10px; }
        
        /* USER UI */
        #user-view { text-align: center; }
        .status-big { font-size: 5rem; margin: 0; line-height: 1; color: var(--main); text-shadow: 0 0 30px var(--main); }
        .sync-mode { font-size: 1.5rem; color: #aaa; margin-top: 10px; letter-spacing: 2px; }
        
        /* JOYSTICK */
        .joy-area { width: 180px; height: 180px; border: 2px solid #333; border-radius: 50%; margin: 10px auto; position: relative; background: #000; }
        .knob { width: 50px; height: 50px; background: var(--main); border-radius: 50%; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); box-shadow: 0 0 20px var(--main); }

        /* USER LIST */
        .user-list { max-height: 200px; overflow-y: auto; text-align: left; }
        .user-item { padding: 8px; border-bottom: 1px solid #222; color: #ccc; font-size: 1.2rem; display: flex; justify-content: space-between; }
        .fix-btn { background: var(--danger); color: white; border: none; font-size: 1rem; padding: 2px 10px; clip-path: none; border-radius: 4px; }

        #player-wrapper { position: absolute; top: -2000px; opacity: 0; pointer-events: none; }
        
        /* COUNTDOWN OVERLAY */
        #countdown { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:99; display:flex; justify-content:center; align-items:center; font-size:10rem; color:white; pointer-events:none; }
    </style>
</head>
<body>

    <div id="login" class="flex-c">
        <h1 style="font-size:4rem; margin:0;">ZERO <span style="color:var(--main)">LATENCY</span></h1>
        <input id="uName" placeholder="Enter Name">
        <button onclick="start('admin')">DJ CONSOLE</button>
        <button onclick="start('user')" style="background:#00aaff; color:white;">LISTENER</button>
    </div>

    <div id="admin-view" class="hidden">
        <div class="deck">
            <input id="yLink" placeholder="YouTube Link" style="width:60%; padding:10px; font-size:1rem;">
            <button onclick="load()" style="font-size:1.2rem; padding:10px 20px;">LOAD</button>
            <div style="margin-top:15px; display:flex; justify-content:space-between; align-items:center;">
                <button onclick="requestPlay()" style="width:48%; background:var(--main);">‚ñ∂ PLAY</button>
                <button onclick="requestPause()" style="width:48%; background:#333; color:white;">‚è∏ PAUSE</button>
            </div>
            <div style="font-size:2rem; color:white; text-align:center; margin-top:10px;" id="admTime">0.0s</div>
        </div>
        
        <h3 style="color:#555; margin:0;">Connected Devices</h3>
        <div class="deck user-list" id="uList"></div>

        <div class="joy-area" id="joyBase"><div class="knob" id="joyKnob"></div></div>
    </div>

    <div id="user-view" class="hidden flex-c">
        <div class="status-big" id="uStatus">READY</div>
        <div class="sync-mode" id="uMode">Waiting for Launch...</div>
        
        <h2 id="volDisp" style="margin-top:50px; font-size:4rem;">100%</h2>
        <p>Volume</p>

        <button onclick="manualLagFix()" style="margin-top:30px; font-size:1.2rem; background:#333; color:#888;">
            ‚ö† Fix 0.7s Lag
        </button>
    </div>

    <div id="countdown" class="hidden"></div>
    <div id="player-wrapper"><div id="player"></div></div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>
    <script>
        const socket = io();
        let player;
        let role = '';
        let LATENCY_OFFSET = 0; // The 0.7s fix variable

        function start(r) {
            let name = document.getElementById('uName').value || "Guest";
            role = r;
            
            // Audio Unlock
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            gain.gain.value = 0.0001; osc.connect(gain); gain.connect(ctx.destination);
            osc.start();

            document.getElementById('login').classList.add('hidden');
            if(role === 'admin') {
                document.getElementById('admin-view').classList.remove('hidden');
                setupJoy();
                startAdminPulse();
            } else {
                document.getElementById('user-view').classList.remove('hidden');
            }
            socket.emit('join', { name: name, role: role });
        }

        // --- YOUTUBE ---
        function onYouTubeIframeAPIReady() {
            player = new YT.Player('player', {
                height: '100%', width: '100%', videoId: '',
                playerVars: { 'playsinline': 1, 'controls': 0, 'disablekb': 1 },
                events: { 'onStateChange': (e) => {} }
            });
        }

        // --- ADMIN LOGIC ---
        function startAdminPulse() {
            setInterval(() => {
                if(player && player.getCurrentTime) {
                    let t = player.getCurrentTime();
                    document.getElementById('admTime').innerText = t.toFixed(1) + "s";
                    // Sync heartbeat
                    if(player.getPlayerState() === 1) {
                        socket.emit('admin_signal', {
                            time: t,
                            isPlaying: true,
                            timestamp: Date.now()
                        });
                    }
                }
            }, 500);
        }

        function load() {
            let url = document.getElementById('yLink').value;
            let id = "";
            if (url.includes("v=")) id = url.split('v=')[1].split('&')[0];
            else if (url.includes("youtu.be/")) id = url.split('youtu.be/')[1].split('?')[0];
            else if (url.length === 11) id = url;
            if(id.length===11) socket.emit('change_track', id);
        }

        // üî• REQUEST PLAY (Doesn't play immediately)
        function requestPlay() {
            if(player) socket.emit('request_play', player.getCurrentTime());
        }
        function requestPause() {
            if(player) socket.emit('request_pause', player.getCurrentTime());
        }

        socket.on('user_update', (users) => {
            if(role!=='admin') return;
            let d = document.getElementById('uList'); d.innerHTML = "";
            for(let k in users) if(users[k].role!=='admin') 
                d.innerHTML += `<div class="user-item"><span>üë§ ${users[k].name}</span> <span style="color:var(--main)">Online</span></div>`;
        });

        // --- USER LOGIC (ZERO LATENCY ENGINE) ---
        socket.on('load_track', (id) => player.loadVideoById(id));
        
        // üöÄ THE MAGIC LAUNCHER üöÄ
        socket.on('execute_launch', (data) => {
            // data.launchAt contains the Server Time to start
            let now = Date.now();
            let delay = data.launchAt - now; // Should be around 1500ms

            // Apply Manual Latency Fix if user clicked the button
            // If user has 0.7s lag, we subtract that? No, the buffer handles it.
            // But if user wants manual offset:
            let seekTo = data.seekTo + LATENCY_OFFSET;

            document.getElementById('uStatus').innerText = "SYNCING";
            document.getElementById('uMode').innerText = `Launching in ${(delay/1000).toFixed(1)}s...`;

            // 1. Move to position
            player.seekTo(seekTo, true);
            player.pauseVideo(); // Hold position

            // 2. Wait for exact moment
            if(delay > 0) {
                // Visual Countdown (Optional)
                showCountdown(delay);
                
                setTimeout(() => {
                    player.playVideo();
                    document.getElementById('uStatus').innerText = "PLAYING";
                    document.getElementById('uMode').innerText = "Zero Latency Mode";
                }, delay);
            } else {
                // If late, just play
                player.playVideo();
            }
        });

        socket.on('execute_pause', (time) => {
            player.seekTo(time, true);
            player.pauseVideo();
            document.getElementById('uStatus').innerText = "PAUSED";
        });

        // Drift Correction (Backup)
        socket.on('sync_pulse', (data) => {
            if(role !== 'user' || !player) return;
            // Only adjust if HUGE drift occurs after launch
            let now = Date.now();
            let target = data.time + ((now - data.timestamp)/1000);
            let myTime = player.getCurrentTime();
            let drift = Math.abs(myTime - target);
            
            if(drift > 1.0) { // Only if more than 1s off
                player.setPlaybackRate(myTime < target ? 1.1 : 0.9);
            } else {
                player.setPlaybackRate(1.0);
            }
        });

        // --- MANUAL LAG FIX ---
        function manualLagFix() {
            LATENCY_OFFSET += 0.1; // Add 0.1s offset each click
            alert(`Latency Offset set to +${LATENCY_OFFSET.toFixed(1)}s. Next time Admin plays, you will jump ahead.`);
        }

        function showCountdown(ms) {
            let el = document.getElementById('countdown');
            el.classList.remove('hidden');
            el.innerText = "READY";
            setTimeout(() => { el.innerText = "SET"; }, ms/2);
            setTimeout(() => { el.classList.add('hidden'); }, ms);
        }

        // Spatial Audio
        socket.on('vol_adjust', (d) => {
            if(role !== 'user') return;
            let dist = Math.sqrt(d.x*d.x + d.y*d.y);
            let vol = Math.max(0, 100 - (dist*50));
            player.setVolume(vol);
            document.getElementById('volDisp').innerText = Math.floor(vol)+"%";
        });

        function setupJoy() {
            const pad=document.getElementById('joyBase'), knob=document.getElementById('joyKnob');
            let drag=false;
            function move(e) {
                e.preventDefault();
                let cx = e.touches?e.touches[0].clientX:e.clientX;
                let cy = e.touches?e.touches[0].clientY:e.clientY;
                let r = pad.getBoundingClientRect();
                let x = cx-(r.left+90), y = cy-(r.top+90);
                let dist = Math.sqrt(x*x+y*y);
                if(dist>60){ x=(x/dist)*60; y=(y/dist)*60; }
                knob.style.transform=`translate(-50%,-50%) translate(${x}px,${y}px)`;
                socket.emit('admin_joystick',{x:x/60, y:y/60});
            }
            knob.addEventListener('mousedown',()=>drag=true);
            document.addEventListener('mouseup',()=>drag=false);
            document.addEventListener('mousemove',(e)=>{if(drag)move(e)});
            knob.addEventListener('touchstart',()=>drag=true);
            document.addEventListener('touchend',()=>drag=false);
            document.addEventListener('touchmove',(e)=>{if(drag)move(e)});
        }
    </script>
</body>
</html>