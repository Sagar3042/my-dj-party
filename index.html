<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚ö° Quantum Sync Cinema</title>
    <style>
        :root { --primary: #e50914; --bg: #141414; --glass: rgba(40, 40, 40, 0.7); }
        body { background-color: var(--bg); color: white; font-family: 'Netflix Sans', 'Helvetica Neue', sans-serif; margin: 0; padding: 0; overflow-x: hidden; }
        
        /* LOGIN MODAL */
        #login-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .login-box { background: #222; padding: 30px; border-radius: 10px; text-align: center; border: 1px solid #444; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        input[type="text"] { padding: 12px; width: 250px; border-radius: 4px; border: none; background: #333; color: white; margin-bottom: 15px; font-size: 16px; outline: none; }
        .btn-enter { padding: 12px 30px; background: var(--primary); color: white; border: none; border-radius: 4px; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-enter:hover { background: #b20710; }

        /* MAIN UI */
        #main-ui { display: none; padding: 20px; max-width: 1200px; margin: auto; }
        
        /* VIDEO PLAYER */
        .cinema-container {
            position: relative; width: 100%; padding-bottom: 56.25%; background: black;
            border-radius: 12px; overflow: hidden; box-shadow: 0 0 50px rgba(229, 9, 20, 0.2);
            border: 2px solid #333;
        }
        #player { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        .click-shield { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; display: none; }

        /* STATUS BAR */
        .status-bar {
            display: flex; justify-content: space-between; align-items: center;
            background: var(--glass); backdrop-filter: blur(10px);
            padding: 15px; margin-top: 20px; border-radius: 8px; border: 1px solid #333;
        }
        .sync-badge { padding: 5px 10px; border-radius: 4px; font-size: 12px; font-weight: bold; text-transform: uppercase; }
        .badge-good { background: rgba(0, 255, 0, 0.2); color: #00ff00; }
        .badge-warn { background: rgba(255, 165, 0, 0.2); color: orange; }
        .badge-bad { background: rgba(255, 0, 0, 0.2); color: red; }

        /* ADMIN DASHBOARD */
        #admin-panel { display: none; margin-top: 30px; animation: fadeIn 0.5s; }
        .admin-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 2px solid #333; padding-bottom: 10px; }
        
        .control-grid { display: grid; grid-template-columns: 3fr 1fr; gap: 20px; margin-bottom: 20px; }
        .video-input { display: flex; gap: 10px; }
        .video-input input { width: 100%; margin: 0; }
        
        .magic-btn {
            background: linear-gradient(45deg, #ff0000, #ff5e00); color: white;
            border: none; padding: 15px; width: 100%; border-radius: 8px;
            font-weight: 900; font-size: 14px; cursor: pointer; letter-spacing: 1px;
            box-shadow: 0 5px 15px rgba(255, 0, 0, 0.3); text-transform: uppercase;
        }
        .magic-btn:active { transform: scale(0.98); }

        /* USER LIST */
        .user-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; }
        .user-card {
            background: #1f1f1f; padding: 15px; border-radius: 8px; border: 1px solid #333;
            display: flex; flex-direction: column; gap: 8px; position: relative;
        }
        .user-name { font-weight: bold; color: #fff; font-size: 16px; }
        .user-stats { font-size: 12px; color: #aaa; font-family: monospace; }
        .user-actions { display: flex; gap: 5px; margin-top: 5px; }
        .mini-btn { flex: 1; padding: 5px; font-size: 10px; cursor: pointer; border: none; border-radius: 3px; color: white; background: #333; }
        .btn-kick { background: #800; } .btn-fix { background: #0056b3; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div id="login-modal">
        <div class="login-box">
            <h2 style="color: var(--primary);">üé¨ ENTER THEATER</h2>
            <input type="text" id="username" placeholder="Your Name...">
            <div style="margin: 15px; text-align: left; font-size: 14px; color: #888;">
                <label><input type="checkbox" id="isAdmin"> I am the Host (Admin)</label>
            </div>
            <button class="btn-enter" onclick="joinParty()">JOIN NOW</button>
        </div>
    </div>

    <div id="main-ui">
        <div class="cinema-container">
            <div id="player"></div>
            <div class="click-shield" id="clickBlocker"></div>
        </div>

        <div class="status-bar">
            <div id="video-title">Waiting for video...</div>
            <div style="text-align: right;">
                <div id="sync-indicator" class="sync-badge badge-good">SYNCED</div>
                <div style="font-size: 11px; color: #666; margin-top: 3px;" id="debug-info">Ping: 0ms | Offset: 0s</div>
            </div>
        </div>

        <div id="admin-panel">
            <div class="admin-header">
                <h3 style="color: var(--primary); margin:0;">üëë HOST CONTROLS</h3>
                <span style="font-size: 12px; color: #888;">You have full control. Users will follow you.</span>
            </div>

            <div class="control-grid">
                <div class="video-input">
                    <input type="text" id="videoUrl" placeholder="Paste YouTube Link...">
                    <button class="btn-enter" onclick="loadVideo()" style="width: 100px;">LOAD</button>
                </div>
                <div>
                    <button class="magic-btn" onclick="forceGlobalSync()">‚ö° FORCE SYNC ALL</button>
                </div>
            </div>

            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <button class="mini-btn" onclick="seekRelative(-10)" style="font-size: 14px; padding: 10px;">‚è™ -10s</button>
                <button class="mini-btn" onclick="seekRelative(10)" style="font-size: 14px; padding: 10px;">‚è© +10s</button>
                <button class="mini-btn" onclick="togglePlay()" style="font-size: 14px; padding: 10px; background: #fff; color:#000;">‚èØ PLAY/PAUSE</button>
            </div>

            <h4 style="border-bottom: 1px solid #333; padding-bottom: 5px; margin-bottom: 10px;">üë§ AUDIENCE MONITOR</h4>
            <div id="user-grid" class="user-grid">
                </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>
    
    <script>
        const socket = io();
        let player;
        let isAdmin = false;
        let myName = "";
        
        // --- SYNC ENGINE VARIABLES ---
        let hostTime = 0;
        let lastPacketTime = 0;
        let networkLatency = 0;
        let isSyncing = false;
        
        // Smart Catch-up thresholds
        const DRIFT_TOLERANCE = 0.2; // 0.2s difference is okay
        const SPEED_CATCHUP_THRESHOLD = 0.5; // If > 0.5s behind, speed up
        const HARD_SYNC_THRESHOLD = 3.0; // If > 3s behind, seek (jump)

        // 1. INITIALIZATION
        function joinParty() {
            myName = document.getElementById('username').value || "Guest";
            isAdmin = document.getElementById('isAdmin').checked;
            
            document.getElementById('login-modal').style.display = 'none';
            document.getElementById('main-ui').style.display = 'block';

            socket.emit('join_user', myName);

            if(isAdmin) {
                document.getElementById('admin-panel').style.display = 'block';
                document.getElementById('clickBlocker').style.display = 'none';
            } else {
                document.getElementById('clickBlocker').style.display = 'block';
            }
        }

        function onYouTubeIframeAPIReady() {
            player = new YT.Player('player', {
                height: '100%', width: '100%',
                videoId: '',
                playerVars: { 'playsinline': 1, 'controls': 0, 'disablekb': 1, 'rel': 0, 'modestbranding': 1 },
                events: { 'onStateChange': onPlayerStateChange, 'onReady': onPlayerReady }
            });
        }

        function onPlayerReady() {
            // Start the Heartbeat Loop
            setInterval(syncLoop, 1000); // Check drift every second
            if(isAdmin) setInterval(broadcastHostTime, 1000); // Host broadcasts time
        }

        // 2. VIDEO CONTROLS
        function loadVideo() {
            let url = document.getElementById('videoUrl').value;
            let id = url.split('v=')[1] || url.split('/').pop();
            if(id) {
                socket.emit('change_video', id);
                document.getElementById('videoUrl').value = "";
            }
        }

        function seekRelative(seconds) {
            if(!player) return;
            let newTime = player.getCurrentTime() + seconds;
            player.seekTo(newTime, true);
        }

        function togglePlay() {
            if(!player) return;
            if(player.getPlayerState() == 1) player.pauseVideo();
            else player.playVideo();
        }

        // 3. CORE SYNC ENGINE (THE MAGIC)
        function syncLoop() {
            if(isAdmin || !player || !player.getCurrentTime) return;

            let myTime = player.getCurrentTime();
            // Estimate current host time: Last known host time + time passed
            let estimatedHostTime = hostTime + ((Date.now() - lastPacketTime) / 1000);
            
            let drift = estimatedHostTime - myTime; // Positive = I am behind
            
            // UI Updates
            updateStatusUI(drift, myTime, estimatedHostTime);
            
            // Report to server
            socket.emit('report_status', { 
                drift: drift.toFixed(2), 
                status: drift > SPEED_CATCHUP_THRESHOLD ? 'Catching Up üèÉ' : 'Synced ‚úÖ' 
            });

            // LOGIC: HOW TO FIX THE DRIFT
            if (Math.abs(drift) < DRIFT_TOLERANCE) {
                // Perfect Sync: Normal Speed
                player.setPlaybackRate(1);
            } 
            else if (drift > HARD_SYNC_THRESHOLD) {
                // Too far behind (>3s): Jump directly (Buffering may happen)
                console.log("Hard Sync Jumping...");
                player.seekTo(estimatedHostTime + 0.5, true);
                player.setPlaybackRate(1);
            } 
            else if (drift > SPEED_CATCHUP_THRESHOLD) {
                // Slightly behind (0.5s - 3s): SPEED UP! (No buffering)
                console.log("Speeding up to 1.5x");
                player.setPlaybackRate(1.5); // Or 2.0
            } 
            else if (drift < -SPEED_CATCHUP_THRESHOLD) {
                // I am ahead: Slow down or Pause briefly
                player.setPlaybackRate(0.5); // Slow down
            }
        }

        function broadcastHostTime() {
            if(player.getPlayerState() == 1) { // Only if playing
                socket.emit('host_time_update', player.getCurrentTime());
            }
        }

        function updateStatusUI(drift, myTime, hostTime) {
            let el = document.getElementById('sync-indicator');
            let dbg = document.getElementById('debug-info');
            
            dbg.innerText = `Host: ${hostTime.toFixed(1)} | Me: ${myTime.toFixed(1)} | Gap: ${drift.toFixed(2)}s`;

            if(Math.abs(drift) < 0.3) {
                el.className = "sync-badge badge-good"; el.innerText = "PERFECT SYNC";
            } else if (Math.abs(drift) < 2) {
                el.className = "sync-badge badge-warn"; el.innerText = "ADJUSTING SPEED...";
            } else {
                el.className = "sync-badge badge-bad"; el.innerText = "LAGGING";
            }
        }

        // 4. SOCKET LISTENERS
        socket.on('change_video', (id) => {
            if(player) player.loadVideoById(id);
        });

        socket.on('server_time_pulse', (data) => {
            hostTime = data.time;
            lastPacketTime = data.timestamp;
            // Calculate network latency (Ping) roughly
            networkLatency = (Date.now() - data.timestamp) / 1000;
        });

        socket.on('video_control', (msg) => {
            if(isAdmin) return;
            if(msg.action === 'play') player.playVideo();
            else if(msg.action === 'pause') player.pauseVideo();
            else if(msg.action === 'seek') player.seekTo(msg.time);
        });

        socket.on('perform_command', (data) => {
            if(isAdmin) return;
            if(data.action === 'force_seek') {
                // The "Magic Button" Effect
                player.seekTo(hostTime + 0.5, true);
                player.playVideo();
                player.setPlaybackRate(1);
            }
        });

        socket.on('update_dashboard', (users) => {
            if(!isAdmin) return;
            const grid = document.getElementById('user-grid');
            grid.innerHTML = "";
            
            users.forEach(u => {
                if(u.id === socket.id) return;
                
                let card = document.createElement('div');
                card.className = 'user-card';
                
                let statusColor = u.status.includes('Synced') ? '#00ff00' : 'orange';
                
                card.innerHTML = `
                    <div class="user-name">${u.name}</div>
                    <div class="user-stats">
                        Gap: <span style="color:${statusColor}">${u.drift}s</span><br>
                        Status: ${u.status}
                    </div>
                    <div class="user-actions">
                        <button class="mini-btn btn-fix" onclick="fixUser('${u.id}')">‚ö° FIX THIS USER</button>
                    </div>
                `;
                grid.appendChild(card);
            });
        });

        // 5. ADMIN FUNCTIONS
        function forceGlobalSync() {
            socket.emit('admin_command', { target: 'all', action: 'force_seek' });
        }
        function fixUser(id) {
            socket.emit('admin_command', { target: id, action: 'force_seek' });
        }

        // Host Control Broadcaster
        function onPlayerStateChange(event) {
            if (!isAdmin) return;
            if (event.data == YT.PlayerState.PLAYING) {
                socket.emit('video_control', { action: 'play', time: player.getCurrentTime() });
            } else if (event.data == YT.PlayerState.PAUSED) {
                socket.emit('video_control', { action: 'pause', time: player.getCurrentTime() });
            } else if (event.data == YT.PlayerState.BUFFERING) {
                 socket.emit('video_control', { action: 'seek', time: player.getCurrentTime() });
            }
        }
    </script>
</body>
</html>